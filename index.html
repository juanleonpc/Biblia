<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Biblia IA</title>
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Biblia IA">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        slate: { 950: '#020617' },
                        emerald: { 500: '#10b981', 600: '#059669', 700: '#047857' },
                        yvGrey: { 50: '#f9f9f9', 100: '#f2f2f2', 800: '#262626', 900: '#1a1a1a' }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.2s ease-out forwards', 
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards' 
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(15px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; overflow-x: hidden; background-color: #f9f9f9; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-top { padding-top: var(--sat); }
        .safe-bottom { padding-bottom: calc(var(--sab) + 4rem); }
        
        .font-reading-sans { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .font-reading-serif { font-family: "Ibarra Real Nova", "Georgia", serif; }
        .font-reading-mono { font-family: "ui-monospace", "SFMono-Regular", "Menlo", monospace; }
        .font-reading-slab { font-family: "Rockwell", "Courier Bold", serif; }

        .highlight-yellow { background-color: #fef9c3; border-left: 4px solid #facc15; } 
        .highlight-green { background-color: #dcfce7; border-left: 4px solid #4ade80; }
        .highlight-blue { background-color: #dbeafe; border-left: 4px solid #60a5fa; }
        .highlight-red { background-color: #fee2e2; border-left: 4px solid #f87171; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: #10b981; border: 4px solid white; margin-top: -9px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: rgba(0,0,0,0.08); border-radius: 3px; }

        /* Evitar zoom automático en móviles forzando 16px en inputs */
        input:not([type="range"]), textarea, select { font-size: 16px !important; }

        .app-shadow { box-shadow: 0 2px 12px -2px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.02); }
    </style>
</head>
<body class="bg-yvGrey-50 text-slate-900 h-[100dvh] overflow-hidden transition-colors duration-300">
    <div id="root" class="h-full flex justify-center w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const apiKey = "";

        // Estructura Católica CEE Actualizada
        const CATHOLIC_BIBLE_STRUCTURE = [
            {
                title: "Antiguo Testamento",
                groups: [
                    {
                        name: "Pentateuco",
                        books: [
                            { id: "Génesis", ch: 50 }, { id: "Éxodo", ch: 40 }, { id: "Levítico", ch: 27 }, 
                            { id: "Números", ch: 36 }, { id: "Deuteronomio", ch: 34 }
                        ]
                    },
                    {
                        name: "Libros históricos",
                        books: [
                            { id: "Josué", ch: 24 }, { id: "Jueces", ch: 21 }, { id: "Rut", ch: 4 }, 
                            { id: "1 Samuel", ch: 31 }, { id: "2 Samuel", ch: 24 }, { id: "1 Reyes", ch: 22 }, 
                            { id: "2 Reyes", ch: 25 }, { id: "1 Crónicas", ch: 29 }, { id: "2 Crónicas", ch: 36 }, 
                            { id: "Esdrás", ch: 10 }, { id: "Nehemías", ch: 13 }, { id: "Tobías", ch: 14 }, 
                            { id: "Judit", ch: 16 }, { id: "Ester", ch: 10 }, { id: "1 Macabeos", ch: 16 }, 
                            { id: "2 Macabeos", ch: 15 }
                        ]
                    },
                    {
                        name: "Libros sapienciales y poéticos",
                        books: [
                            { id: "Job", ch: 42 }, { id: "Salmos", ch: 150 }, { id: "Proverbios", ch: 31 }, 
                            { id: "Eclesiastés", ch: 12 }, { id: "Cantar de los cantares", ch: 8 }, { id: "Sabiduría", ch: 19 }, 
                            { id: "Eclesiástico", ch: 51 }
                        ]
                    },
                    {
                        name: "Libros proféticos",
                        books: [
                            { id: "Isaías", ch: 66 }, { id: "Jeremías", ch: 52 }, { id: "Lamentaciones", ch: 5 }, 
                            { id: "Baruc", ch: 6 }, { id: "Ezequiel", ch: 48 }, { id: "Daniel", ch: 14 }, 
                            { id: "Oseas", ch: 14 }, { id: "Joel", ch: 3 }, { id: "Amós", ch: 9 }, 
                            { id: "Abdías", ch: 1 }, { id: "Jonás", ch: 4 }, { id: "Miqueas", ch: 7 }, 
                            { id: "Nahún", ch: 3 }, { id: "Habacuc", ch: 3 }, { id: "Sofonías", ch: 3 }, 
                            { id: "Ageo", ch: 2 }, { id: "Zacarías", ch: 14 }, { id: "Malaquías", ch: 4 }
                        ]
                    }
                ]
            },
            {
                title: "Nuevo Testamento",
                groups: [
                    {
                        name: "Evangelios",
                        books: [
                            { id: "Mateo", ch: 28 }, { id: "Marcos", ch: 16 }, { id: "Lucas", ch: 24 }, { id: "Juan", ch: 21 }
                        ]
                    },
                    {
                        name: "Hechos de los apóstoles",
                        books: [
                            { id: "Hechos", ch: 28 }
                        ]
                    },
                    {
                        name: "Corpus paulino",
                        books: [
                            { id: "Romanos", ch: 16 }, { id: "1 Corintios", ch: 16 }, { id: "2 Corintios", ch: 13 }, 
                            { id: "Gálatas", ch: 6 }, { id: "Efesios", ch: 6 }, { id: "Filipenses", ch: 4 }, 
                            { id: "Colosenses", ch: 4 }, { id: "1 Tesalonicenses", ch: 5 }, { id: "2 Tesalonicenses", ch: 3 }, 
                            { id: "1 Timoteo", ch: 6 }, { id: "2 Timoteo", ch: 4 }, { id: "Tito", ch: 3 }, 
                            { id: "Filemón", ch: 1 }, { id: "Hebreos", ch: 13 }
                        ]
                    },
                    {
                        name: "Cartas católicas",
                        books: [
                            { id: "Santiago", ch: 5 }, { id: "1 Pedro", ch: 5 }, { id: "2 Pedro", ch: 3 }
                        ]
                    },
                    {
                        name: "Cartas de San Juan",
                        books: [
                            { id: "Juan. Cartas 1-3", ch: 7 }
                        ]
                    },
                    {
                        name: "Judas",
                        books: [
                            { id: "Judas", ch: 1 }
                        ]
                    },
                    {
                        name: "Apocalipsis",
                        books: [
                            { id: "Apocalipsis", ch: 22 }
                        ]
                    }
                ]
            }
        ];

        const BIBLE_BOOKS_MAP = {
            1: "Génesis", 2: "Éxodo", 3: "Levítico", 4: "Números", 5: "Deuteronomio", 6: "Josué", 7: "Jueces", 8: "Rut", 9: "1 Samuel", 10: "2 Samuel",
            11: "1 Reyes", 12: "2 Reyes", 13: "1 Crónicas", 14: "2 Crónicas", 15: "Esdrás", 16: "Nehemías", 17: "Ester", 18: "Job", 19: "Salmos", 20: "Proverbios",
            21: "Eclesiastés", 22: "Cantar de los cantares", 23: "Isaías", 24: "Jeremías", 25: "Lamentaciones", 26: "Ezequiel", 27: "Daniel", 28: "Oseas", 29: "Joel", 30: "Amós",
            31: "Abdías", 32: "Jonás", 33: "Miqueas", 34: "Nahún", 35: "Habacuc", 36: "Sofonías", 37: "Ageo", 38: "Zacarías", 39: "Malaquías", 40: "Mateo",
            41: "Marcos", 42: "Lucas", 43: "Juan", 44: "Hechos", 45: "Romanos", 46: "1 Corintios", 47: "2 Corintios", 48: "Gálatas", 49: "Efesios", 50: "Filipenses",
            51: "Colosenses", 52: "1 Tesalonicenses", 53: "2 Tesalonicenses", 54: "1 Timoteo", 55: "2 Timoteo", 56: "Tito", 57: "Filemón", 58: "Hebreos", 59: "Santiago", 60: "1 Pedro",
            61: "2 Pedro", 62: "Juan. Cartas 1-3", 65: "Judas", 66: "Apocalipsis"
        };
        
        // Orden canónico actualizado para incluir todos los libros presentes en la estructura
        const CANONICAL_ORDER = [
            "Génesis", "Éxodo", "Levítico", "Números", "Deuteronomio", "Josué", "Jueces", "Rut", "1 Samuel", "2 Samuel",
            "1 Reyes", "2 Reyes", "1 Crónicas", "2 Crónicas", "Esdrás", "Nehemías", "Tobías", "Judit", "Ester", "1 Macabeos", "2 Macabeos",
            "Job", "Salmos", "Proverbios", "Eclesiastés", "Cantar de los cantares", "Sabiduría", "Eclesiástico", 
            "Isaías", "Jeremías", "Lamentaciones", "Baruc", "Ezequiel", "Daniel", "Oseas", "Joel", "Amós", "Abdías", "Jonás", "Miqueas", "Nahún", "Habacuc", "Sofonías", "Ageo", "Zacarías", "Malaquías",
            "Mateo", "Marcos", "Lucas", "Juan", "Hechos", "Romanos", "1 Corintios", "2 Corintios", "Gálatas", "Efesios", "Filipenses",
            "Colosenses", "1 Tesalonicenses", "2 Tesalonicenses", "1 Timoteo", "2 Timoteo", "Tito", "Filemón", "Hebreos", 
            "Santiago", "1 Pedro", "2 Pedro", "Juan. Cartas 1-3", "Judas", "Apocalipsis"
        ];

        const PREDEFINED_PLANS = [
            { id: 'sabiduria', title: 'Sabiduría diaria', desc: 'Un proverbio al día para iluminar tu camino práctico y un salmo para fortalecer tu espíritu.', duration: 31, category: 'Hábitos', icon: 'fa-sun', bookRef: 'Proverbios' },
            { id: 'juan21', title: 'Los 21 días de Juan', desc: 'La mejor puerta de entrada a la Biblia. Conoce a Jesús íntimamente a través del Evangelio del Amor.', duration: 21, category: 'Principiantes', icon: 'fa-heart', bookRef: 'Juan' },
            { id: 'evangelios', title: 'Armonía de los evangelios', desc: 'La vida de Cristo en orden cronológico, unificando los relatos de Mateo, Marcos, Lucas y Juan.', duration: 45, category: 'Vida de Jesús', icon: 'fa-dove', bookRef: 'Mateo' },
            { id: 'fundamentos', title: 'Fundamentos de la fe', desc: 'Explora las doctrinas centrales: Creación, Gracia, Redención y Eternidad en pasajes clave.', duration: 15, category: 'Doctrina', icon: 'fa-gavel', bookRef: 'Romanos' },
            { id: 'nt90', title: <span>Nuevo Testamento<br/>en 90 días</span>, desc: 'Un reto intensivo pero transformador para leer todos los libros desde Mateo hasta Apocalipsis.', duration: 90, category: 'Reto', icon: 'fa-bolt', bookRef: 'Mateo' },
            { id: 'biografias', title: 'Tras los pasos de Pablo', desc: 'Sigue los viajes misioneros y el fuego del apóstol de los gentiles a través de Hechos.', duration: 10, category: 'Personajes', icon: 'fa-person-walking', bookRef: 'Hechos' },
            { id: 'cronologico', title: 'Plan cronológico', desc: 'Lee la Biblia en el orden real de los sucesos históricos, desde el Caos hasta la Nueva Jerusalén.', duration: 365, category: 'Avanzado', icon: 'fa-timeline', bookRef: 'Génesis' },
            { id: 'anio', title: 'La Biblia en un año', desc: 'El plan clásico: Antiguo Testamento, Nuevo Testamento y Salmos cada día sin falta.', duration: 365, category: 'Clásico', icon: 'fa-calendar-days', bookRef: 'Génesis' },
            { id: 'relatos', title: 'Los grandes relatos', desc: 'Solo los hitos: David y Goliat, El Éxodo, Sansón... las historias que cambiaron el mundo.', duration: 30, category: 'Panorámico', icon: 'fa-mountain', bookRef: 'Génesis' }
        ];

        const BIBLICAL_CURIOSITIES = [
            { title: "¿Manzana prohibida?", text: "El Génesis nunca menciona una manzana. El texto original solo habla del 'fruto'. La confusión viene del latín 'malus', que significa tanto 'mal' como 'manzana'." },
            { title: "El capítulo más largo", text: "El Salmo 119 es el capítulo más largo de la Biblia. Es un acróstico alfabético: cada sección comienza con una letra del alfabeto hebreo." },
            { title: "Idiomas originales", text: "La Biblia no se escribió en español. El Antiguo Testamento está en Hebreo y Arameo, mientras que el Nuevo Testamento fue escrito en Griego Koiné." },
            { title: "Amen", text: "La palabra 'Amén' es una de las pocas que se ha mantenido casi idéntica en hebreo, griego, latín, español e inglés. Significa 'Así sea' o 'Verdaderamente'." },
            { title: "No temas", text: "La frase 'No temas' o sus variantes aparecen 365 veces en las Escrituras, una para cada día del año, recordándonos la providencia diaria de Dios." },
            { title: "El versículo más corto", text: "Juan 11:35, 'Jesús lloró', es conocido como el versículo más corto, mostrando la profunda humanidad y compasión de Cristo." },
            { title: "Matusalén", text: "Matusalén es la persona más longeva mencionada en la Biblia, con 969 años. Su nombre puede significar 'cuando él muera, será enviado' (el Diluvio)." },
            { title: "Sin trinidad", text: "La palabra teológica 'Trinidad' no aparece explícitamente en la Biblia, aunque el concept de Padre, Hijo y Espíritu Santo está presente en muchos pasajes." },
            { title: "Más de 40 autores", text: "La Biblia fue escrita por más de 40 autores de diferentes profesiones: reyes, pescadores, médicos, granjeros y pastores, a lo largo de 1500 años." },
            { title: "El centro de la Biblia", text: "Muchos consideran el Salmo 118:8 el centro de la Biblia: 'Mejor es confiar en Jehová que confiar en el hombre'." },
            { title: "¿Gatos?", text: "Se mencionan perros 14 veces en la Biblia, leones 55 veces, pero los gatos domésticos no se mencionan ni una sola vez." },
            { title: "El juez zurdo", text: "Aod fue un juez zurdo que liberó a Israel. La Biblia especifica su mano izquierda porque la usó para esconder su espada y sorprender al rey Eglón." },
            { title: "Animales que hablan", text: "Solo hay dos casi de animales hablando en la Biblia: la serpiente en el Edén y la burra del profeta Balaam." },
            { title: "El cabello más pesado", text: "Absalón, hijo de David, tenía un cabello tan denso que se lo cortaba una vez al año y pesaba unos 2 kilos (200 siclos reales)." },
            { title: "Sermón mortal", text: "Un joven llamado Eutico se durmió durante un largo sermón de Pablo, cayó de un tercer piso y murió, pero Pablo bajó y lo resucitó." },
            { title: "El profeta calvo", text: "Eliseo era calvo. Un grupo de muchachos se burló de él gritándole '¡Sube, calvo!', y fueron atacados por dos osas (2 Reyes 2:23)." },
            { title: "Fuerza sobrenatural", text: "Sansón no era necesariamente musculoso; su fuerza venía del Espíritu de Dios. Mató a mil filisteos usando solo una quijada de burro reciente sin problema." },
            { title: "La cama gigante", text: "La cama de Og, rey de Basán (uno de los últimos gigantes), medía 9 codos de largo, lo que equivale aproximadamente a 4 metros." },
            { title: "El Nombre", text: "El nombre personal de Dios (YHWH) aparece casi 7.000 veces en el Antiguo Testamento, más que cualquier otro título." },
            { title: "Libros perdidos", text: "La Biblia menciona libros que no están incluidos en el canon, como el 'Libro de las Batallas de Jehová' o el 'Libro de Jaser'." },
            { title: "El primer paraíso", text: "El primer hombre en recibir la promesa de entrar al Paraíso con Jesús fue el ladrón arrepentido crucificado a su lado." },
            { title: "Sueños bíblicos", text: "Hay 21 sueños registrados en la Biblia. Curiosamente, la mayoría de ellos involucran a dos hombres diferentes llamados José." },
            { title: "Servicio a domicilio", text: "Durante una sequía, Dios ordenó a unos cuervos que llevaran pan y carne al profeta Elías por la mañana y por la tarde." },
            { title: "¿Llovía antes?", text: "Génesis 2 sugiere que antes del Diluvio no llovía, sino que un vapor subía de la tierra para regar las plantas." },
            { title: "Estatua de sal", text: "La mujer de Lot se convirtió en una estatua de sal por mirar atrás hacia Sodoma, simbolizando el apego a la vida pasada." },
            { title: "Sombra sanadora", text: "La gente sacaba a los enfermos a las calles esperando que al menos la sombra del apóstol Pedro cayera sobre ellos para sanarlos." },
            { title: "El día largo", text: "En el libro de Josué, el sol se detuvo en medio del cielo durante casi un día entero para que Israel pudiera terminar una batalla." },
            { title: "Hierro flotante", text: "El profeta Eliseo hizo un milagro donde un hacha de hierro que cayó al agua salió a flote para que su dueño la recuperara." },
            { title: "Maná", text: "La palabra 'Maná' suena como la frase hebrea '¿Qué es esto?', que fue lo que preguntaron los israelitas al verlo por primera vez." },
            { title: "Sin genealogía", text: "Melquisedec aparece como un tipo de Cristo: un rey y sacerdote del que no se registra padre, madre, nacimiento ni muerte." },
            { title: "Tinta insuficiente", text: "El apóstol Juan termina su evangelio diciendo que si se escribiera todo lo que hizo Jesús, no cabrían los libros en el mundo." },
            { title: "Príncipe de Paz", text: "Isaías profetizó sobre el Mesías llamándolo 'Admirable, Consejero, Dios Fuerte, Padre Eterno, Príncipe de Paz'." },
            { title: "Vida animal", text: "El rey Nabucodonosor fue castigado con la locura, viviendo como una base, coniendo hierba hasta que reconoció a Dios." },
            { title: "El pacto", text: "El arcoíris no es solo un fenómeno óptico en la Biblia, es la señal visible del pacto de Dios de no volver a inundar la tierra." }
        ];

        const SEARCH_TAGS = ["Paz", "Ansiedad", "Familia", "Perdón", "Sabiduría", "Fortaleza", "Esperanza", "Miedo", "Amor", "Justicia"];

        async function fetchGemini(userKey, prompt, retries = 5, isJson = false) {
            const cleanKey = (userKey && userKey.trim()) || apiKey;
            if (!cleanKey) return { error: "Falta configurar la API Key en Ajustes." };
            const systemPrompt = `Eres un erudito bíblico experto. Tu conocimiento abarca todos los libros de la Biblia. Proporciona conocimiento profundo pero muy conciso. Responde siempre en ESPAÑOL. REGLAS: NO USES negritas (**). NO introducciones ni despedidas. Aunque el usuario solo tenga algunos libros instalados, tú debes citar y conectar versículos de toda la Biblia para dar un entendimiento global.`;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${cleanKey}`;
            
            const payload = { 
                contents: [{ role: "user", parts: [{ text: prompt }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: isJson ? { responseMimeType: "application/json" } : {}
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    const result = await resp.json();
                    
                    if (!resp.ok) {
                        const errorMsg = result.error?.message || "";
                        if (resp.status === 429 || errorMsg.toLowerCase().includes("quota") || errorMsg.toLowerCase().includes("limit")) {
                            return { error: "Has alcanzado el límite de consultas gratuitas de la IA. Por favor, espera unos segundos antes de intentar de nuevo." };
                        }
                        throw new Error(errorMsg || "Error de red");
                    }
                    
                    return { data: result.candidates?.[0]?.content?.parts?.[0]?.text };
                } catch (e) {
                    if (i === retries - 1) return { error: e.message };
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        const DB_NAME = 'Bible_App_Persistent_V2';
        const db = {
            init: () => new Promise(res => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => { const d = e.target.result; if (!d.objectStoreNames.contains('appData')) d.createObjectStore('appData'); };
                req.onsuccess = e => res(e.target.result);
                req.onerror = () => res(null);
            }),
            get: (key) => new Promise(async res => {
                const inst = await db.init(); if(!inst) return res(null);
                const req = inst.transaction('appData', 'readonly').objectStore('appData').get(key);
                req.onsuccess = () => res(req.result);
                req.onerror = () => res(null);
            }),
            set: (key, val) => new Promise(async res => {
                const inst = await db.init(); if(!inst) return res(null);
                inst.transaction('appData', 'readwrite').objectStore('appData').put(val, key).oncomplete = () => res();
            })
        };

        function App() {
            const [view, setView] = useState('home');
            const [bibleData, setBibleData] = useState({});
            const [annotations, setAnnotations] = useState({});
            const [favorites, setFavorites] = useState([]);
            const [readStatus, setReadStatus] = useState({});
            const [verseReadStatus, setVerseReadStatus] = useState({});
            const [verseImages, setVerseImages] = useState({}); 
            const [versePrompts, setVersePrompts] = useState({}); 
            const [lastPosition, setLastPosition] = useState(null); 
            const [planProgress, setPlanProgress] = useState({});
            const [streak, setStreak] = useState({ count: 0, lastDate: null });
            const [fontSize, setFontSize] = useState(20);
            const [fontFamily, setFontFamily] = useState('sans');
            const [currentChapter, setCurrentChapter] = useState({book: '', chapter: 1});
            const [ready, setReady] = useState(false);
            const [activeV, setActiveV] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiVersePanel, setAiVersePanel] = useState(null);
            const [studyVerseId, setStudyVerseId] = useState(null); 
            const [asstQuery, setAsstQuery] = useState("");
            const [asstRole, setAsstRole] = useState("teólogo");
            const [asstResponses, setAsstResponses] = useState({ 'teólogo': '', 'historiador': '', 'pastor': '' });
            const [searchQ, setSearchQ] = useState("");
            const [searchRes, setSearchRes] = useState([]);
            const [aiSummary, setAiSummary] = useState(""); 
            const [showDeepen, setShowDeepen] = useState(false); 
            const [userApiKey, setUserApiKey] = useState("");
            const [noteInput, setNoteInput] = useState("");
            const [editingNoteId, setEditingNoteId] = useState(null);
            const [editingNoteText, setEditingNoteText] = useState("");
            const [apiError, setApiError] = useState("");
            const [importText, setImportText] = useState("");
            const [importStatus, setImportStatus] = useState("");
            const [activePlan, setActivePlan] = useState(null);
            const [missingBook, setMissingBook] = useState(null);
            const fileInputRef = useRef(null);
            const backupInputRef = useRef(null);
            const mainRef = useRef(null); 
            const [settingsPart, setSettingsPart] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [searchBook, setSearchBook] = useState("todos");
            const [searchTestamentState, setSearchTestament] = useState("todos"); 
            const [searchScope, setSearchScope] = useState("texto");
            const [matchType, setMatchType] = useState("frase");
            const [capStart, setCapStart] = useState("");
            const [capEnd, setCapEnd] = useState("");
            const [showSearchFilters, setShowSearchFilters] = useState(false);
            const [favSearchQ, setFavSearchQ] = useState("");
            const [favBook, setFavBook] = useState("todos");
            const [favTestament, setFavTestament] = useState("todos");
            const [favMatchType, setFavMatchType] = useState("frase");
            const [favSortOrder, setFavSortOrder] = useState("reciente");
            const [showFavFilters, setShowFavFilters] = useState(false);
            const [iaEmotion, setIaEmotion] = useState("");
            const [exegesisWord, setExegesisWord] = useState("");
            const [showExegesisInput, setShowExegesisInput] = useState(false);
            const [exegesisList, setExegesisList] = useState([]); 
            const [expandedBook, setExpandedBook] = useState(null);
            const [verseOfTheDay, setVerseOfTheDay] = useState(null);
            const [dailyCuriosity, setDailyCuriosity] = useState(null);
            const [manualBookSelect, setManualBookSelect] = useState("");
            
            // Estado para la PILA DE NAVEGACIÓN
            const [navStack, setNavStack] = useState([]);

            const [navSearchQ, setNavSearchQ] = useState("");
            const [showNavFilters, setShowNavFilters] = useState(false);
            const [navTestamentFilter, setNavTestamentFilter] = useState("todos");

            const [showUI, setShowUI] = useState(true);
            const lastScrollY = useRef(0);

            const booksList = useMemo(() => Object.keys(bibleData), [bibleData]);

            useEffect(() => {
                if (mainRef.current) {
                    mainRef.current.scrollTop = 0;
                    setShowUI(true);
                }
            }, [view, settingsPart, currentChapter]);

            useEffect(() => {
                const load = async () => {
                    const saved = await db.get('config_vBibleData');
                    const bData = await db.get('bible_content');
                    if (bData) { setBibleData(bData); const firstBook = Object.keys(bData)[0]; if (firstBook) setCurrentChapter({book: firstBook, chapter: 1}); }
                    if (saved) {
                        setAnnotations(saved.annotations || {});
                        setFavorites(saved.favorites || []);
                        setReadStatus(saved.readStatus || {});
                        setVerseReadStatus(saved.verseReadStatus || {});
                        setVerseImages(saved.verseImages || {});
                        setVersePrompts(saved.versePrompts || {});
                        setLastPosition(saved.lastPosition || null);
                        setPlanProgress(saved.planProgress || {});
                        setStreak(saved.streak || { count: 0, lastDate: null });
                        setFontSize(saved.fontSize || 20);
                        setFontFamily(saved.fontFamily || 'sans');
                        setUserApiKey(saved.userApiKey || "");
                    }
                    
                    if (bData) {
                        const books = Object.keys(bData);
                        if (books.length > 0) {
                            const randomBook = books[Math.floor(Math.random() * books.length)];
                            const chapters = Object.keys(bData[randomBook]);
                            const randomChap = chapters[Math.floor(Math.random() * chapters.length)];
                            const verses = bData[randomBook][randomChap];
                            const randomVIdx = Math.floor(Math.random() * verses.length);
                            if (verses[randomVIdx]) {
                                setVerseOfTheDay({
                                    text: verses[randomVIdx],
                                    ref: `${randomBook} ${randomChap}:${randomVIdx + 1}`,
                                    b: randomBook,
                                    c: randomChap,
                                    v: randomVIdx + 1
                                });
                            }
                        }
                    }
                    
                    const randomCuriosity = BIBLICAL_CURIOSITIES[Math.floor(Math.random() * BIBLICAL_CURIOSITIES.length)];
                    setDailyCuriosity(randomCuriosity);

                    setReady(true);
                };
                load();
            }, []);

            useEffect(() => {
                if (ready) {
                    const saveConfig = async () => {
                        try {
                            await db.set('config_vBibleData', { 
                                annotations, favorites, readStatus, verseReadStatus, 
                                verseImages, versePrompts, lastPosition, fontSize, 
                                fontFamily, planProgress, streak, userApiKey 
                            });
                        } catch (e) { console.error("Error al guardar config:", e); }
                    };
                    saveConfig();
                }
            }, [ready, annotations, favorites, readStatus, verseReadStatus, verseImages, versePrompts, lastPosition, fontSize, fontFamily, planProgress, streak, userApiKey]);

            const updateStreak = () => {
                const today = new Date().toISOString().split('T')[0];
                if (streak.lastDate === today) return;
                setStreak(prev => ({ count: prev.count + 1, lastDate: today }));
            };

            const handleToggleVerse = (vId) => {
                updateStreak();
                setApiError("");
                
                if (activeV !== vId) { 
                    setShowExegesisInput(false);
                    setActiveV(vId); 
                    setEditingNoteId(null); 
                    setTimeout(() => { 
                        const el = document.getElementById(vId); 
                        if (el && mainRef.current) {
                            const topOffset = el.offsetTop - 120;
                            mainRef.current.scrollTo({ top: topOffset, behavior: 'smooth' });
                        }
                    }, 250);
                } else { 
                    setActiveV(null); 
                    setShowExegesisInput(false); 
                }
            };

            const toggleVerseRead = (vId, e) => {
                e.stopPropagation();
                updateStreak();
                
                const parts = vId.split('-');
                const bookName = parts[0];
                const chapNum = parts[1];
                const chapterKey = `${bookName}-${chapNum}`;
                const newStatus = !verseReadStatus[vId];

                setVerseReadStatus(prev => {
                    const nextVerseStatus = { ...prev, [vId]: newStatus };
                    const chapterVerses = bibleData[bookName][chapNum] || [];
                    const allVersesRead = chapterVerses.every((txt, idx) => {
                        if (!txt) return true; 
                        const currentVId = `${bookName}-${chapNum}-${idx + 1}`;
                        if (currentVId === vId) return newStatus;
                        return nextVerseStatus[currentVId];
                    });
                    setReadStatus(prevRead => ({ ...prevRead, [chapterKey]: allVersesRead }));
                    return nextVerseStatus;
                });
                
                if(parts.length === 3) {
                    setLastPosition({ book: parts[0], chapter: parseInt(parts[1]), verse: parseInt(parts[2]), timestamp: Date.now() });
                }
            };

            const getBookProgress = (bookName) => {
                if (!bibleData[bookName]) return 0;
                const totalChapters = Object.keys(bibleData[bookName]).length;
                let completedChapters = 0;
                Object.keys(bibleData[bookName]).forEach(c => {
                    if (readStatus[`${bookName}-${c}`]) completedChapters++;
                });
                return Math.round((completedChapters / totalChapters) * 100);
            };

            const toggleFav = (vId, text, reference, b, c) => {
                const already = favorites.some(f => f.id === vId);
                if (already) setFavorites(prev => prev.filter(f => f.id !== vId));
                else setFavorites(prev => [...prev, { id: vId, text, ref: reference, b, c, timestamp: Date.now() }]);
            };

            const handleShare = async (text, reference) => {
                const shareText = `"${text}" (${reference}) - Vía Biblia IA`;
                if (navigator.share) {
                    try {
                        await navigator.share({ title: 'Biblia IA', text: shareText });
                        return;
                    } catch (err) {}
                }
                const textArea = document.createElement("textarea");
                textArea.value = shareText;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try { document.execCommand('copy'); } catch (err) {}
                document.body.removeChild(textArea);
            };

            const handleGeneratePromptOnly = (text, vId) => {
                const idParts = vId.split('-');
                const book = idParts[0] || "";
                const chapter = idParts[1] || "";
                const verse = idParts[2] || "";
                const reference = `${book} ${chapter}:${verse}`;
                const promptText = `A stunning, hyper-realistic biblical scene in full vibrant colors with sharp defined lines and crisp outlines, portrait orientation (vertical 9:16). Style: High-end realistic fine art with clear textures, well-defined structures, and cinematic lighting. Every element must have sharp focus and distinct edges. Lighting and Atmosphere: Use radiant, majestic, and warm light to perfectly match the emotional tone of the verse. Scene based on the Holy Bible, ${reference}. Image content: "${text}". The color palette should be rich, saturated, and divine. At the bottom, an elegant parchment scroll displays: "${text} (${reference})". Masterpiece quality, ultra-sharp focus, 8k resolution, breathtaking details.`;
                setVersePrompts(prev => ({ ...prev, [vId]: promptText }));
            };

            const saveNoteEdit = (vId, noteId) => {
                if (!editingNoteText.trim()) return;
                const cur = annotations[vId] || {};
                const updatedNotes = (cur.notes || []).map(n => n.id === noteId ? { ...n, text: editingNoteText } : n);
                setAnnotations({ ...annotations, [vId]: { ...cur, notes: updatedNotes } });
                setEditingNoteId(null); setEditingNoteText("");
            };

            const handleSearch = () => {
                const q = searchQ.toLowerCase().trim();
                if (!q) { setSearchRes([]); setShowDeepen(false); return; }
                setAiSummary(""); 
                const results = []; const words = q.split(/\s+/);
                const cStart = parseInt(capStart); const cEnd = parseInt(capEnd);
                booksList.forEach(b => {
                    if (searchBook !== "todos" && searchBook !== b) return;
                    const bId = Object.keys(BIBLE_BOOKS_MAP).find(k => BIBLE_BOOKS_MAP[k] === b);
                    if (searchTestamentState === "antiguo" && parseInt(bId) > 39) return;
                    if (searchTestamentState === "nuevo" && parseInt(bId) <= 39) return;
                    const bData = bibleData[b]; if (!bData) return;
                    Object.keys(bData).forEach(c => {
                        const chapterNum = parseInt(c);
                        if (!isNaN(cStart) && chapterNum < cStart) return;
                        if (!isNaN(cEnd) && chapterNum > cEnd) return;
                        const verses = bData[c] || [];
                        verses.forEach((t, i) => {
                            if (!t) return;
                            const vId = `${b}-${c}-${i+1}`;
                            const meta = annotations[vId] || {};
                            const notesText = (meta.notes || []).map(n => n.text).join(" ").toLowerCase();
                            const verseText = String(t).toLowerCase();
                            let match = false;
                            const checkMatch = (target) => { 
                                if (matchType === "frase") return target.includes(q); 
                                return words.every(w => target.includes(w)); 
                            };
                            if (searchScope === "texto" || searchScope === "ambos") { if (checkMatch(verseText)) match = true; }
                            if (!match && (searchScope === "notes" || searchScope === "ambos")) { if (checkMatch(notesText)) match = true; }
                            if (match) results.push({ b, c, v: i+1, t, noteMatch: !verseText.includes(q) }); 
                        });
                    });
                });
                setSearchRes(results); 
                setShowSearchFilters(false);
                setShowDeepen(true); 
            };

            const handleConceptualSearch = async (queryOverride) => {
                const q = (typeof queryOverride === 'string' ? queryOverride : searchQ).trim();
                if (!q || aiLoading) return;
                setAiLoading(true); setSearchRes([]); setApiError(""); setAiSummary(""); setShowDeepen(false);
                if (typeof queryOverride === 'string') setSearchQ(queryOverride);
                const prompt = `Como experto bíblico, proporciona una reflexión breve (máx 3 frases) sobre este tema: "${q}". 
                Luego encuentra hasta 10 pasajes de TODA LA BIBLIA (todos los libros) relacionados. 
                Si el usuario pide navegar ("Vete a...", "Abre...", "Llévame a..."), identifica el pasaje exacto.
                Responde EXCLUSIVAMENTE con este formato JSON: 
                {"reflexion": "texto de la reflexion espiritual", "resultados": [{"ref": "Libro Cap:Ver", "explicacion": "breve razon"}]}`;
                const result = await fetchGemini(userApiKey, prompt, 5, true);
                if (result.data) {
                    try {
                        const parsed = JSON.parse(result.data);
                        setAiSummary(parsed.reflexion || "");
                        const mapped = [];
                        (parsed.resultados || []).forEach(res => {
                            const match = res.ref.match(/^(.+?)\s+(\d+)[:\s](\d+)$/);
                            if (match) { 
                                const [_, b, c, v] = match; 
                                const bookData = bibleData[b]; const text = bookData?.[c]?.[parseInt(v)-1];
                                mapped.push({ b, c, v, t: text || "(Texto no disponible localmente. Pulsa para instalar este libro)", iaComment: res.explicacion, isMissing: !text }); 
                            }
                        });
                        setSearchRes(mapped);
                    } catch (e) { setApiError("Error interpretando respuesta de la IA."); }
                } else if (result.error) {
                    setApiError(result.error);
                }
                setAiLoading(false);
            };

            const handleSynthesis = async (txt) => {
                if (studyVerseId !== activeV) { setExegesisList([]); setStudyVerseId(activeV); }
                else if (aiVersePanel) { return; }
                setAiLoading(true); setApiError("");
                const prompt = `Analiza profundamente el siguiente versículo bíblico desde cuatro perspectivas. Responde EXCLUSIVAMENTE en un objeto JSON válido con estas claves exactas: "teologo", "historiador", "pastor", "referencias". Versículo a analizar: "${txt}"`;
                const result = await fetchGemini(userApiKey, prompt, 5, true);
                if (result.data) {
                    try {
                        const rawParsed = JSON.parse(result.data);
                        const normalized = {};
                        const mapping = { 'teologo': ['teologo', 'teólogo', 'teologia', 'teología'], 'historiador': ['historiador', 'historia'], 'pastor': ['pastor', 'pastoral', 'aplicacion', 'aplicación'], 'referencias': ['referencias', 'ref', 'citas'] };
                        Object.keys(rawParsed).forEach(k => {
                            const cleanKey = k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
                            for(let masterKey in mapping) { if(mapping[masterKey].some(variant => cleanKey.includes(variant))) { normalized[masterKey] = rawParsed[k]; break; } }
                        });
                        ['teologo', 'historiador', 'pastor', 'referencias'].forEach(k => { if(!normalized[k]) normalized[k] = rawParsed[k] || "No disponible."; });
                        setAiVersePanel(normalized);
                    } catch (e) { setApiError("Error de formato en la respuesta de IA."); }
                } else if (result.error) { setAiVersePanel(null); setApiError(result.error); }
                setAiLoading(false);
            };

            const handleExegesis = async (txt) => {
                if (!exegesisWord.trim()) return;
                const wordToSearch = exegesisWord.trim();
                setAiLoading(true); setApiError("");
                const prompt = `Analiza únicamente el significado de la palabra "${wordToSearch}" en el contexto de este versículo: "${txt}". Responde EXCLUSIVAMENTE en un objeto JSON válido con estas claves exactas: "original" (palabra en su idioma fuente y transliteración), "significado" (definición clara y concisa).`;
                const result = await fetchGemini(userApiKey, prompt, 5, true);
                if (result.data) {
                    try {
                        const parsed = JSON.parse(result.data);
                        if (studyVerseId !== activeV) { setAiVersePanel(null); setExegesisList([{ ...parsed, word: wordToSearch }]); setStudyVerseId(activeV); }
                        else { setExegesisList(prev => [...prev, { ...parsed, word: wordToSearch }]); }
                        setShowExegesisInput(false); setExegesisWord("");
                    } catch (e) { setApiError("Error en formato de diccionario."); }
                } else if (result.error) { setApiError(result.error); }
                setAiLoading(false);
            };

            const handleAssistantAsk = async () => {
                if (!asstQuery.trim() || aiLoading) return;
                setAiLoading(true);
                const result = await fetchGemini(userApiKey, `Actúa como ${asstRole} bíblico con conocimiento de todos los libros de la Biblia: ${asstQuery}`);
                if (result.data) { setAsstResponses(prev => ({ ...prev, [asstRole]: result.data })); }
                else if (result.error) { setAsstResponses(prev => ({ ...prev, [asstRole]: result.error })); }
                setAiLoading(false); updateStreak();
            };

            const handleGenerateSituationalPlan = async () => {
                if (!iaEmotion.trim() || aiLoading) return;
                setAiLoading(true); setApiError("");
                const prompt = `Crea un plan devocional de 7 días buscando en TODA LA BIBLIA para alguien que se siente: "${iaEmotion}". Responde SOLO JSON: {"title": "Nombre Plan", "days": [{"b": "Libro", "c": 1, "desc": "reflexion"}]}`;
                const result = await fetchGemini(userApiKey, prompt, 5, true);
                if (result.data) {
                    try {
                        const parsed = JSON.parse(result.data);
                        const newPlan = { id: `ia-${Date.now()}`, title: parsed.title, days: parsed.days, category: 'IA Personalizado', icon: 'fa-wand-magic-sparkles', custom: true, duration: 7 };
                        setActivePlan(newPlan); PREDEFINED_PLANS.unshift(newPlan); setIaEmotion("");
                    } catch (e) { setApiError("Error generando el plan."); }
                } else if (result.error) {
                    setApiError(result.error);
                }
                setAiLoading(false);
            };

            const processImport = async (inputData) => {
                try {
                    let parsed = {}; 
                    const text = inputData.replace(/\r\n/g, '\n').trim();
                    if (!text) throw new Error("Texto vacío");

                    if (text.startsWith('{')) { 
                        parsed = JSON.parse(text); 
                    } else {
                        const tupleRegex = /\(?\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*['"](.*?)['"]\s*\)?/;
                        const naturalRegex = /^(.+?)\s+(\d+)\s*[:\.,\s-]\s*(\d+)\s+(.+)$/;

                        let standardMatchCount = 0;
                        const lines = text.split('\n');
                        
                        lines.forEach(line => {
                            let cleanLine = line.trim().replace(/\s+/g, ' '); 
                            if (!cleanLine) return;
                            let m = cleanLine.match(tupleRegex);
                            if (m) { 
                                const [_, bId, chapter, verse, content] = m; 
                                const bName = manualBookSelect || (BIBLE_BOOKS_MAP[bId] || `Libro ${bId}`); 
                                if (!parsed[bName]) parsed[bName] = {}; 
                                if (!parsed[bName][chapter]) parsed[bName][chapter] = []; 
                                parsed[bName][chapter][parseInt(verse)-1] = content.replace(/\/n/g, '\n'); 
                                standardMatchCount++;
                            } else { 
                                m = cleanLine.match(naturalRegex); 
                                if (m) { 
                                    const [_, book, chapter, verse, content] = m; 
                                    const cleanBook = manualBookSelect || book.trim();
                                    const cleanContent = content.trim().replace(/^["']|["']$/g, '');
                                    if (!parsed[cleanBook]) parsed[cleanBook] = {}; 
                                    if (!parsed[cleanBook][chapter]) parsed[cleanBook][chapter] = []; 
                                    parsed[cleanBook][chapter][parseInt(verse)-1] = cleanContent; 
                                    standardMatchCount++;
                                } 
                            }
                        });

                        if (standardMatchCount === 0) {
                            const bName = manualBookSelect || "Libro Importado";
                            if (!parsed[bName]) parsed[bName] = {};
                            
                            let currentChapter = 1;
                            
                            lines.forEach(line => {
                                let lineText = line.trim();
                                if(!lineText) return;
                                
                                const firstNumMatch = lineText.match(/^(\d+)/);
                                if (firstNumMatch) {
                                    const num = firstNumMatch[1];
                                    if (num.length >= 2 && num.endsWith('1')) {
                                        currentChapter = parseInt(num.slice(0, -1));
                                    }
                                }

                                if (!parsed[bName][currentChapter]) parsed[bName][currentChapter] = [];

                                let vMatch;
                                const vRegex = /(\d+)\s*([^\d]+)(?=\d|$)/g;
                                while ((vMatch = vRegex.exec(lineText)) !== null) {
                                    let vNum = parseInt(vMatch[1]);
                                    let vText = vMatch[2].trim().replace(/^["']|["']$/g, '').replace(/\|/g, '');
                                    
                                    if (vNum > 10 && (vNum % 10 === 1) && vMatch.index === 0) {
                                        vNum = 1;
                                    }
                                    
                                    if (vText) {
                                        parsed[bName][currentChapter][vNum-1] = vText;
                                    }
                                }
                            });
                        }
                    }
                    
                    if (Object.keys(parsed).length === 0 || Object.keys(parsed).every(k => Object.keys(parsed[k]).length === 0)) {
                        throw new Error("No se pudo reconocer el texto.");
                    }
                    
                    const merged = { ...bibleData }; 
                    Object.keys(parsed).forEach(b => { 
                        if (!merged[b]) merged[b] = parsed[b]; 
                        else Object.keys(parsed[b]).forEach(c => merged[b][c] = parsed[b][c]); 
                    });
                    
                    setBibleData(merged); 
                    await db.set('bible_content', merged);
                    
                    if (!currentChapter.book) { 
                        const first = Object.keys(merged)[0]; 
                        if (first) setCurrentChapter({book: first, chapter: 1}); 
                    }
                    
                    setImportStatus("¡Libro(s) cargado(s) correctamente!"); 
                    setImportText("");
                    setTimeout(() => setImportStatus(""), 4000);
                } catch (e) { 
                    setImportStatus("Error: " + e.message); 
                    setTimeout(() => setImportStatus(""), 4000);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader(); reader.onload = (event) => processImport(event.target.result);
                reader.readAsText(file);
            };

            const handleExportBackup = async () => {
                try {
                    setImportStatus("");
                    const backup = { app: 'Biblia IA', version: '2.5', timestamp: new Date().toISOString(), config: { annotations, favorites, readStatus, verseReadStatus, verseImages, versePrompts, lastPosition, fontSize, fontFamily, planProgress, streak, userApiKey }, bibleData: bibleData };
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; 
                    a.download = `Backup_BibliaIA_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                    
                    setImportStatus("Copia de seguridad creada correctamente"); 
                    setTimeout(() => setImportStatus(""), 5000);
                } catch (e) { 
                    setImportStatus("Error exportando: " + e.message);
                    setTimeout(() => setImportStatus(""), 5000);
                }
            };

            const handleImportBackup = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const inputElement = e.target;
                const reader = new FileReader(); reader.onload = async (event) => {
                    try {
                        setImportStatus("");
                        const backup = JSON.parse(event.target.result);
                        if (backup.app !== 'Biblia IA') throw new Error("Archivo no válido.");
                        const { config, bibleData: bData } = backup;
                        
                        if (config) { 
                            setAnnotations(config.annotations || {}); 
                            setFavorites(config.favorites || []); 
                            setReadStatus(config.readStatus || {}); 
                            setVerseReadStatus(config.verseReadStatus || {}); 
                            setVerseImages(config.verseImages || {}); 
                            setVersePrompts(config.versePrompts || {}); 
                            setLastPosition(config.lastPosition || null); 
                            setPlanProgress(config.planProgress || {}); 
                            setStreak(config.streak || { count: 0, lastDate: null }); 
                            setFontSize(config.fontSize || 20); 
                            setFontFamily(config.fontFamily || 'sans'); 
                            
                            if (config.userApiKey) setUserApiKey(config.userApiKey);
                        }
                        
                        if (bData) { 
                            setBibleData(bData); 
                            await db.set('bible_content', bData);
                            const first = Object.keys(bData)[0]; 
                            if (first) setCurrentChapter({ book: first, chapter: 1 }); 
                        }
                        
                        const count = bData ? Object.keys(bData).length : 0;
                        setImportStatus(`Restauración exitosa: ${count} libros cargados`); 
                        setTimeout(() => setImportStatus(""), 6000);
                        inputElement.value = "";
                    } catch (err) { 
                        setImportStatus("Error al restaurar: " + err.message); 
                        setTimeout(() => setImportStatus(""), 6000);
                        inputElement.value = "";
                    }
                };
                reader.readAsText(file);
            };

            const togglePlanDay = (planId, dayIndex) => {
                const cur = planProgress[planId] || []; const updated = cur.includes(dayIndex) ? cur.filter(d => d !== dayIndex) : [...cur, dayIndex];
                setPlanProgress({ ...planProgress, [planId]: updated }); updateStreak();
            };

            const filteredFavorites = useMemo(() => {
                const res = favorites.filter(f => {
                    const q = favSearchQ.toLowerCase().trim(); const words = q.split(/\s+/);
                    const meta = annotations[f.id] || {}; const notesText = (meta.notes || []).map(n => n.text).join(" ").toLowerCase(); const verseText = f.text.toLowerCase();
                    let textMatch = true;
                    if (q) { if (favMatchType === "frase") textMatch = verseText.includes(q) || notesText.includes(q); else textMatch = words.every(w => verseText.includes(w) || notesText.includes(w)); }
                    if (!textMatch) return false;
                    if (favBook !== "todos" && f.b !== favBook) return false;
                    const bId = Object.keys(BIBLE_BOOKS_MAP).find(k => BIBLE_BOOKS_MAP[k] === f.b);
                    if (favTestament === "antiguo" && bId && parseInt(bId) > 39) return false;
                    if (favTestament === "nuevo" && bId && parseInt(bId) <= 39) return false;
                    return true;
                });
                if (favSortOrder === "reciente") res.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                else {
                    res.sort((a, b) => {
                        const idxA = CANONICAL_ORDER.indexOf(a.b);
                        const idxB = CANONICAL_ORDER.indexOf(b.b);
                        if (idxA !== -1 && idxB !== -1) {
                            if (idxA !== idxB) return idxA - idxB;
                        }
                        if (a.c !== b.c) return a.c - b.c;
                        const vA = parseInt(a.ref.split(":")[1]); const vB = parseInt(b.ref.split(":")[1]); return vA - vB;
                    });
                }
                return res;
            }, [favorites, favSearchQ, favBook, favTestament, favMatchType, favSortOrder, annotations]);

            const favBooksInList = useMemo(() => {
                const bks = [...new Set(favorites.map(f => f.b))];
                return bks.sort((a, b) => CANONICAL_ORDER.indexOf(a) - CANONICAL_ORDER.indexOf(b));
            }, [favorites]);

            const filteredNavStructure = useMemo(() => {
                return CATHOLIC_BIBLE_STRUCTURE.map(testament => {
                    if (navTestamentFilter !== "todos" && testament.title !== navTestamentFilter) return null;
                    
                    const filteredGroups = testament.groups.map(group => {
                        const filteredBooks = group.books.filter(book => 
                            book.id.toLowerCase().includes(navSearchQ.toLowerCase())
                        );
                        if (filteredBooks.length === 0) return null;
                        return { ...group, books: filteredBooks };
                    }).filter(Boolean);

                    if (filteredGroups.length === 0) return null;
                    return { ...testament, groups: filteredGroups };
                }).filter(Boolean);
            }, [navSearchQ, navTestamentFilter]);

            // Lógica para VOLVER EN LA PILA
            const handleGoBack = () => {
                if (navStack.length === 0) return;
                const newStack = [...navStack];
                const last = newStack.pop();
                setNavStack(newStack);
                
                // Restaurar la vista anterior (Buscador, Asistente, Biblia...)
                const targetView = last.fromView || 'reading';
                setView(targetView);
                
                // Restaurar coordenadas bíblicas
                setCurrentChapter({ book: last.book, chapter: last.chapter });

                // Restaurar estados específicos de lectura si volvemos a la Biblia
                if (targetView === 'reading') {
                    setActiveV(last.activeV || null);
                    setAiVersePanel(last.aiVersePanel || null);
                    setExegesisList(last.exegesisList || []);
                    setStudyVerseId(last.studyVerseId || null);
                }

                // Restaurar la posición exacta del scroll guardada
                if (last.scrollPos !== undefined) {
                    setTimeout(() => {
                        if (mainRef.current) {
                            mainRef.current.scrollTo({ top: last.scrollPos, behavior: 'instant' });
                        }
                    }, 150); // Delay mínimo para que el cambio de vista surta efecto en el DOM
                }
            };

            const pushToStack = () => {
                if (!currentChapter.book) return;
                const scrollPos = mainRef.current ? mainRef.current.scrollTop : 0;
                
                // Guardamos el versículo actual, la vista, scroll Y el estado del estudio profundo/exégesis
                setNavStack(prev => [...prev, { 
                    book: currentChapter.book, 
                    chapter: currentChapter.chapter, 
                    activeV: activeV,
                    aiVersePanel: aiVersePanel,
                    exegesisList: exegesisList,
                    studyVerseId: studyVerseId,
                    fromView: view,
                    scrollPos: scrollPos
                }]);
            };

            const SectionHeader = ({ title, onClose, children }) => (
                <div className="flex justify-between items-center mb-4">
                    <h2 className="text-xs font-bold text-emerald-600 uppercase tracking-[0.2em]">{title}</h2>
                    <div className="flex items-center gap-3">{children}<button onClick={onClose} className="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:text-rose-500 transition-colors"><i className="fa-solid fa-xmark text-lg"></i></button></div>
                </div>
            );

            const LinkifiedText = ({ content }) => {
                if (typeof content !== 'string') return content;
                
                const REF_MAP = {
                    ...Object.values(BIBLE_BOOKS_MAP).reduce((acc, val) => ({...acc, [val]: val}), {}),
                    "Gn": "Génesis", "Gen": "Génesis", "Ex": "Éxodo", "Lv": "Levítico", "Nm": "Números", "Dt": "Deuteronomio",
                    "Jos": "Josué", "Jue": "Jueces", "Rt": "Rut", "1 Sm": "1 Samuel", "2 Sm": "2 Samuel", 
                    "1 Re": "1 Reyes", "2 Re": "2 Reyes", "1 Cr": "1 Crónicas", "2 Cr": "2 Crónicas",
                    "Esd": "Esdrás", "Neh": "Nehemías", "Est": "Ester", "Job": "Job", "Sal": "Salmos", "Prov": "Proverbios",
                    "Ecl": "Eclesiastés", "Cant": "Cantar de los cantares", "Cantares": "Cantar de los cantares", "Is": "Isaías", "Jer": "Jeremías", "Lam": "Lamentaciones",
                    "Ez": "Ezequiel", "Dn": "Daniel", "Os": "Oseas", "Jl": "Joel", "Am": "Amós", "Abd": "Abdías",
                    "Jon": "Jonás", "Miq": "Miqueas", "Nah": "Nahún", "Nahúm": "Nahún", "Hab!": "Habacuc", "Sof": "Sofonías", "Ag": "Ageo",
                    "Zac": "Zacarías", "Mal": "Malaquías", "Mt": "Mateo", "Mc": "Marcos", "Lc": "Lucas", "Jn": "Juan",
                    "Hch": "Hechos", "Rom": "Romanos", "1 Cor": "1 Corintios", "2 Cor": "2 Corintios", "Gal": "Gálatas",
                    "Ef": "Efesios", "Flp": "Filipenses", "Col": "Colosenses", "1 Tes": "1 Tesalonicenses", "2 Tes!": "2 Tesalonicenses",
                    "1 Tim": "1 Timoteo", "2 Tim": "2 Timoteo", "Tit": "Tito", "Flm": "Filemón", "Heb": "Hebreos",
                    "Sant": "Santiago", "1 Pe": "1 Pedro", "2 Pe": "2 Pedro", "1 Jn": "Juan. Cartas 1-3", "2 Jn": "Juan. Cartas 1-3",
                    "3 Jn": "Juan. Cartas 1-3", "1 Juan": "Juan. Cartas 1-3", "2 Juan": "Juan. Cartas 1-3", "3 Juan": "Juan. Cartas 1-3", "Jds": "Judas", "Ap": "Apocalipsis"
                };

                const normalize = (s) => s ? s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\./g, '') : "";
                const keys = Object.keys(REF_MAP).sort((a, b) => b.length - a.length);
                const bookPattern = keys.map(b => b.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
                const regex = new RegExp(`\\b(${bookPattern})\\s+(\\d+)(?:[:\\.,]\\s*(\\d+))?\\b`, 'gi');
                
                const parts = content.split(regex);
                const result = [];
                for (let i = 0; i < parts.length; i += 4) {
                    result.push(parts[i]);
                    if (i + 1 < parts.length) {
                        const detected = parts[i + 1];
                        const chap = parts[i + 2]; 
                        const ver = parts[i + 3];
                        const lookupKey = detected.replace(/\.$/, '');
                        const canonicalName = REF_MAP[detected] || REF_MAP[lookupKey] || detected;
                        const displayRef = `${detected} ${chap}${ver ? ':' + ver : ''}`;
                        
                        result.push(
                            <span key={`book-${i}`} onClick={(e) => {
                                e.stopPropagation();
                                const normCanon = normalize(canonicalName);
                                const targetBook = Object.values(BIBLE_BOOKS_MAP).find(b => normalize(b) === normCanon);

                                if (targetBook && bibleData[targetBook]) {
                                    const targetChapterNum = parseInt(chap); 
                                    const targetVerseNum = ver ? parseInt(ver) : null;
                                    
                                    // PUSH A LA PILA: Guardamos el estado y el scroll actual antes de navegar
                                    pushToStack();

                                    setCurrentChapter({ book: targetBook, chapter: targetChapterNum }); 
                                    setView('reading');
                                    setTimeout(() => { if (targetVerseNum) { handleToggleVerse(`${targetBook}-${targetChapterNum}-${targetVerseNum}`); } }, 400);
                                } else { setMissingBook(targetBook || canonicalName); }
                            }} className="text-emerald-600 font-semibold underline decoration-emerald-500/20 cursor-pointer hover:decoration-emerald-500 transition-all px-0.5">{displayRef}</span>
                        );
                    }
                }
                return <>{result}</>;
            };

            const ExpertItem = ({ icon, title, text, color }) => (
                <div className={`mb-4 border-l-4 pl-4 pr-3 py-4 border-${color}-500 bg-${color}-50/40 rounded-r-xl animate-fade-in shadow-sm w-full group relative`}>
                    <div className="flex items-center gap-2 mb-2.5"><i className={`fa-solid ${icon} text-[13px] text-${color}-600`}></i><span className="font-bold text-[10px] uppercase tracking-wider text-${color}-800/60">{title}</span></div>
                    <div className="text-[18px] leading-relaxed text-slate-700 font-medium break-words whitespace-pre-wrap"><LinkifiedText content={text} /></div>
                </div>
            );

            const closeToReading = () => { setView('reading'); setActivePlan(null); setSettingsPart(null); setShowDeleteConfirm(false); setImportStatus(""); };

            const getSettingsTitle = () => {
                if (!settingsPart) return "Ajustes";
                const titles = { 'apariencia': 'Apariencia', 'ia': 'Configuración IA', 'backup': 'Copia de seguridad', 'biblioteca': 'Biblioteca' };
                return titles[settingsPart] || settingsPart;
            };

            const NavItem = ({v, i, l}) => {
                const isActive = view === v || (v === 'reading' && view === 'nav');
                return (
                    <button 
                        onClick={() => { 
                            if (v === 'reading' && !currentChapter.book) {
                                setView('nav');
                            } else {
                                setView(v); 
                            }
                            setActivePlan(null); 
                            setSettingsPart(null); 
                            setNavStack([]); // Limpiar historial al cambiar manualmente de sección
                        }} 
                        className={`flex flex-col items-center justify-center flex-1 gap-1 transition-all ${isActive ? 'text-emerald-600' : 'text-slate-400'}`}
                    >
                        <div className={`w-8 h-8 flex items-center justify-center rounded-xl transition-all ${isActive ? 'bg-emerald-50' : ''}`}>
                            <i className={`fa-solid ${i} text-[18px]`}></i>
                        </div>
                        <span className="text-[10px] font-bold uppercase tracking-tighter">{l}</span>
                    </button>
                );
            }
            
            const handleScroll = (e) => {
                const currentScrollY = e.currentTarget.scrollTop;
                const delta = currentScrollY - lastScrollY.current;
                
                if (delta > 10 && currentScrollY > 100) {
                    if (showUI) setShowUI(false);
                } 
                else if (delta < -15) {
                    if (!showUI) setShowUI(true);
                }
                
                if (currentScrollY < 30 && !showUI) {
                    setShowUI(true);
                }
                
                lastScrollY.current = currentScrollY;
            };

            if (!ready) return null;

            return (
                <div className={`flex flex-col h-full w-full md:max-w-3xl shadow-2xl overflow-hidden transition-all relative mx-auto bg-yvGrey-50 text-slate-800`}>
                    
                    {importStatus && view !== 'settings' && (
                        <div onClick={() => setImportStatus("")} className="fixed bottom-24 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 bg-slate-900/95 backdrop-blur-md text-white rounded-full shadow-2xl animate-slide-up flex items-center gap-3 cursor-pointer hover:bg-slate-800 active:scale-95 transition-all">
                            <i className={`fa-solid ${importStatus.startsWith('Error') ? 'fa-circle-exclamation text-rose-400' : 'fa-check text-emerald-400'} text-sm`}></i>
                            <span className="text-xs font-bold uppercase tracking-wider">{importStatus}</span>
                            <span className="ml-2 text-[10px] opacity-40 uppercase">(Cerrar)</span>
                        </div>
                    )}

                    {missingBook && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 animate-fade-in">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setMissingBook(null)}></div>
                            <div className="bg-white w-full max-sm rounded-[2rem] p-8 shadow-2xl relative z-10 animate-slide-up text-center border">
                                <div className="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center text-emerald-600 mx-auto mb-5"><i className="fa-solid fa-book-open text-2xl"></i></div>
                                <h3 className="text-lg font-bold text-slate-800 mb-2">Libro no disponible</h3>
                                <p className="text-slate-500 text-sm mb-6 leading-relaxed">El libro <span className="font-bold text-emerald-600">"{missingBook}"</span> no está en tu biblioteca. Súbelo para comenzar.</p>
                                <div className="space-y-2">
                                    <button onClick={() => { setView('settings'); setMissingBook(null); }} className="w-full py-4 bg-emerald-600 text-white font-bold uppercase text-[11px] rounded-xl shadow-lg active:scale-95 transition-all">Ir a ajustes</button>
                                    <button onClick={() => setMissingBook(null)} className="w-full py-4 text-slate-400 font-bold uppercase text-[11px]">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header className={`fixed top-0 left-0 right-0 md:max-w-3xl md:mx-auto bg-white border-b border-slate-100 z-40 transition-transform duration-300 ${showUI ? 'translate-y-0' : '-translate-y-full'}`}>
                        <div className="safe-top">
                            <div className="flex justify-between items-center px-4 pt-3 pb-1">
                                <div className="flex items-center gap-3">
                                    <h1 className="font-black text-lg tracking-tighter text-emerald-600 italic">Biblia IA</h1>
                                </div>
                            </div>
                            <div className="px-4 pb-2">
                                <button onClick={() => { setView('nav'); setActivePlan(null); setSettingsPart(null); }} className="w-full text-left px-4 py-3 rounded-xl bg-slate-50 border border-slate-100 shadow-sm flex justify-between items-center active:scale-[0.98] transition-all group">
                                    <span className="flex items-center gap-2.5">
                                        <i className="fa-solid fa-layer-group text-emerald-600 opacity-40"></i>
                                        <span className="text-slate-700 font-bold text-sm">{currentChapter.book || "Libros"}</span>
                                        {currentChapter.book && <span className="text-slate-400 font-medium text-xs tracking-wide">Capítulo {currentChapter.chapter}</span>}
                                    </span>
                                    <i className="fa-solid fa-chevron-right text-[10px] text-slate-300 group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* MEJORA: BOTÓN FLOTANTE DE VOLVER SIMPLIFICADO Y CON MEMORIA DE SCROLL Y ESTUDIO */}
                    {navStack.length > 0 && view === 'reading' && (
                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 z-50 animate-slide-up w-auto">
                            <button 
                                onClick={handleGoBack}
                                className="bg-slate-900/80 backdrop-blur-md text-white py-3 px-8 rounded-full shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-all border border-white/10"
                            >
                                <i className="fa-solid fa-arrow-left text-xs"></i>
                                <span className="text-[11px] font-black uppercase tracking-widest">Volver</span>
                            </button>
                        </div>
                    )}

                    <main ref={mainRef} onScroll={handleScroll} className={`flex-grow overflow-y-auto no-scrollbar relative w-full transition-all duration-300`} 
                          style={{ paddingTop: showUI ? 'calc(105px + var(--sat))' : 'calc(45px + var(--sat))' }}>
                        {view === 'home' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                <div className="flex justify-between items-end mb-8 mt-4">
                                    <div>
                                        <h2 className="text-2xl font-black text-slate-800 tracking-tight">¡Hola de nuevo!</h2>
                                        <p className="text-slate-400 text-sm font-medium">¿Qué quieres estudiar hoy?</p>
                                    </div>
                                    <div className="flex flex-col items-center gap-1">
                                        <div className="w-14 h-14 rounded-2xl bg-orange-50 flex items-center justify-center text-orange-500 shadow-sm"><i className="fa-solid fa-fire text-2xl"></i></div>
                                        <span className="text-[10px] font-black uppercase text-orange-600">{streak.count} días</span>
                                    </div>
                                </div>

                                {verseOfTheDay && (
                                    <div className="p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm relative overflow-hidden group">
                                        <div className="absolute top-4 right-6 text-[10px] font-black text-emerald-500 uppercase tracking-widest">Versículo del día</div>
                                        <i className="fa-solid fa-quote-left absolute top-10 left-6 text-slate-50 text-6xl pointer-events-none"></i>
                                        <div className="relative z-10">
                                            <p className="text-xl font-reading-serif font-bold text-slate-700 italic leading-relaxed mb-6">"{verseOfTheDay.text}"</p>
                                            <div className="flex justify-between items-center">
                                                <span onClick={() => { setCurrentChapter({book: verseOfTheDay.b, chapter: verseOfTheDay.c}); setView('reading'); setTimeout(() => handleToggleVerse(`${verseOfTheDay.b}-${verseOfTheDay.c}-${verseOfTheDay.v}`), 300); }} className="text-[11px] font-black text-emerald-600 tracking-widest uppercase cursor-pointer hover:underline">{verseOfTheDay.ref}</span>
                                                <div className="flex gap-2">
                                                    <button onClick={() => handleShare(verseOfTheDay.text, verseOfTheDay.ref)} className="w-9 h-9 flex items-center justify-center bg-slate-50 text-slate-400 rounded-full"><i className="fa-solid fa-share-nodes"></i></button>
                                                    <button onClick={() => toggleFav(`${verseOfTheDay.b}-${verseOfTheDay.c}-${verseOfTheDay.v}`, verseOfTheDay.text, verseOfTheDay.ref, verseOfTheDay.b, verseOfTheDay.c)} className={`w-9 h-9 flex items-center justify-center rounded-full ${favorites.some(f => f.id === `${verseOfTheDay.b}-${verseOfTheDay.c}-${verseOfTheDay.v}`) ? 'bg-yellow-50 text-yellow-500' : 'bg-slate-50 text-slate-400'}`}><i className="fa-solid fa-star"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                {dailyCuriosity && (
                                    <div className="mt-8 mb-8 p-8 rounded-[2rem] bg-amber-50 border border-amber-100 shadow-sm relative overflow-hidden">
                                        <div className="absolute -top-6 -right-6 opacity-10 text-amber-600 text-9xl rotate-12"><i className="fa-regular fa-lightbulb"></i></div>
                                        <div className="relative z-10">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-10 h-10 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center"><i className="fa-solid fa-lightbulb text-lg"></i></div>
                                                <span className="text-[10px] font-black uppercase tracking-widest text-amber-600/60">Sabías que...</span>
                                            </div>
                                            <h3 className="text-xl font-black text-slate-800 mb-3">{dailyCuriosity.title}</h3>
                                            <p className="text-slate-600 text-[15px] font-medium leading-relaxed">{dailyCuriosity.text}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'reading' && (
                            <div className={`animate-fade-in w-full pb-32 font-reading-${fontFamily}`}>
                                {!currentChapter.book ? <div className="p-20 text-center text-slate-400 italic">Sube un libro en ajustes para comenzar tu lectura.</div> : (
                                    <>
                                        <div className="flex justify-between items-center mt-6 mb-4 px-6">
                                            <h2 className="text-3xl font-serif font-black text-slate-800">{currentChapter.book} {currentChapter.chapter}</h2>
                                            <button onClick={() => { setReadStatus(p => ({ ...p, [`${currentChapter.book}-${currentChapter.chapter}`]: !p[`${currentChapter.book}-${currentChapter.chapter}`] })); updateStreak(); }} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${readStatus[`${currentChapter.book}-${currentChapter.chapter}`] ? 'bg-emerald-500 text-white shadow-lg' : 'bg-slate-100 text-slate-300'}`}><i className="fa-solid fa-check"></i></button>
                                        </div>
                                        <div className="space-y-0 w-full">
                                            {(bibleData[currentChapter.book]?.[currentChapter.chapter] || []).map((txt, i) => {
                                                if (!txt) return null;
                                                const vId = `${currentChapter.book}-${currentChapter.chapter}-${i+1}`;
                                                const meta = annotations[vId] || {}; const isFav = favorites.some(f => f.id === vId);
                                                const isVerseRead = verseReadStatus[vId];
                                                return (
                                                    <div key={vId} id={vId} className={`px-5 py-3 transition-all w-full relative ${meta.color ? `highlight-${meta.color}` : 'hover:bg-slate-50/50'}`}>
                                                        <div className="w-full">
                                                            <p style={{ fontSize: `${fontSize}px`, lineHeight: 1.6 }} onClick={() => handleToggleVerse(vId)} className={`cursor-pointer font-medium text-justify tracking-tight leading-relaxed text-slate-800`}>
                                                                <span onClick={(e) => toggleVerseRead(vId, e)} className={`mr-1.5 text-[15px] font-bold align-baseline transition-all cursor-pointer select-none rounded px-1.5 py-0.5 ${isVerseRead ? 'bg-emerald-600 text-white shadow-sm' : 'text-emerald-600'}`}>{i+1}</span>
                                                                <span className={`${isVerseRead ? 'opacity-40' : ''} transition-opacity`}><LinkifiedText content={txt} /></span>
                                                            </p>
                                                            {meta.notes?.map(n => (
                                                                <div key={n.id} className="mt-3 w-full bg-amber-50 p-4 rounded-r-xl border-l-4 border-amber-300 italic flex flex-col font-reading-sans">
                                                                    {editingNoteId === n.id ? (
                                                                        <div className="flex flex-col gap-3"><textarea autoFocus value={editingNoteText} onChange={e => setEditingNoteText(e.target.value)} className="w-full p-3 rounded-xl bg-white border outline-none text-base not-italic" /><div className="flex justify-end gap-2"><button onClick={() => setEditingNoteId(null)} className="px-4 py-2 text-xs font-bold uppercase text-slate-400">Cancelar</button><button onClick={() => saveNoteEdit(vId, n.id)} className="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold uppercase">Guardar</button></div></div>
                                                                    ) : (
                                                                        <div className="flex justify-between items-start gap-4"><span className="opacity-90 leading-relaxed text-[15px] text-slate-700"><LinkifiedText content={n.text} /></span><div className="flex gap-1 shrink-0"><button onClick={() => { setEditingNoteId(n.id); setEditingNoteText(n.text); }} className="p-2 text-blue-400 opacity-60 hover:opacity-100"><i className="fa-solid fa-pen text-base"></i></button><button onClick={() => setAnnotations({...annotations, [vId]: {...meta, notes: meta.notes.filter(x=>x.id!==n.id)}})} className="p-2 text-rose-400 opacity-60 hover:opacity-100"><i className="fa-solid fa-trash text-base"></i></button></div></div>
                                                                    )}
                                                                </div>
                                                            ))}
                                                            {activeV === vId && (
                                                                <div className="mt-6 animate-slide-up font-reading-sans overflow-hidden w-full border-t border-slate-200/60 pt-6">
                                                                    <div className="flex justify-between items-center mb-6">
                                                                        <div className="flex gap-2.5">
                                                                            <button onClick={() => setAnnotations({...annotations, [vId]: {...meta, color: null}})} className={`w-7 h-7 rounded-full border border-slate-200 bg-white flex items-center justify-center transition-all`}><i className="fa-solid fa-droplet-slash text-[10px] text-slate-400"></i></button>
                                                                            {['yellow', 'green', 'blue', 'red'].map(c => (
                                                                                <button key={c} onClick={() => setAnnotations({...annotations, [vId]: {...meta, color: meta.color === c ? null : c}})} className={`w-7 h-7 rounded-full highlight-${c} border-2 ${meta.color === c ? 'border-emerald-500 scale-110' : 'border-transparent shadow-sm'} transition-transform`}></button>
                                                                            ))}
                                                                        </div>
                                                                        <div className="flex gap-1.5 items-center">
                                                                            <button onClick={() => handleShare(txt, `${currentChapter.book} ${currentChapter.chapter}:${i+1}`)} className="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-emerald-500"><i className="fa-solid fa-share-nodes text-lg"></i></button>
                                                                            <button onClick={() => handleGeneratePromptOnly(txt, vId)} className={`w-10 h-10 flex items-center justify-center transition-all ${versePrompts[vId] ? 'text-emerald-600' : 'text-slate-300 hover:text-emerald-500'}`}><i className="fa-solid fa-image text-lg"></i></button>
                                                                            <button onClick={() => toggleFav(vId, txt, `${currentChapter.book} ${currentChapter.chapter}:${i+1}`, currentChapter.book, currentChapter.chapter)} className={`w-10 h-10 flex items-center justify-center transition-all ${isFav ? 'text-yellow-500' : 'text-slate-300'}`}><i className="fa-solid fa-star text-lg"></i></button>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {versePrompts[vId] && (
                                                                        <div className="mb-6 p-4 bg-emerald-50/30 rounded-2xl border border-emerald-100 animate-fade-in">
                                                                            <div className="flex justify-between items-center mb-2"><span className="text-[10px] font-bold uppercase tracking-widest text-emerald-600">Visualización IA</span><i className="fa-solid fa-robot text-xs text-emerald-600/30"></i></div>
                                                                            <p className="text-[13px] font-medium leading-relaxed italic text-slate-600 mb-4">"{versePrompts[vId]}"</p>
                                                                            <button onClick={() => { const el = document.createElement('textarea'); el.value = versePrompts[vId]; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); setImportStatus("Prompt copiado."); setTimeout(() => setImportStatus(""), 3000); }} className="w-full py-3 bg-emerald-600 text-white rounded-xl text-[10px] font-bold uppercase shadow-md active:scale-95 transition-all flex items-center justify-center gap-2"><i className="fa-solid fa-copy"></i>Copiar para generar</button>
                                                                        </div>
                                                                    )}
                                                                    <div className="flex gap-2 w-full mb-5">
                                                                        <input value={noteInput} onChange={e => setNoteInput(e.target.value)} placeholder="Escribe tu reflexión..." className="flex-grow p-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none text-sm font-medium" />
                                                                        <button onClick={() => { if(!noteInput) return; const cur = annotations[vId] || {}; setAnnotations({...annotations, [vId]: { ...cur, notes: [...(cur.notes || []), { id: Date.now(), text: noteInput }] } }); setNoteInput(""); updateStreak(); }} className="bg-emerald-600 text-white px-5 rounded-xl font-bold text-xs shadow-lg">OK</button>
                                                                    </div>
                                                                    <div className="grid grid-cols-2 gap-3 mb-6">
                                                                        <button onClick={() => setShowExegesisInput(!showExegesisInput)} className={`flex items-center justify-center gap-2 py-3.5 rounded-xl text-[10px] font-bold uppercase transition-all border ${showExegesisInput ? 'bg-emerald-600 text-white border-emerald-600 shadow-lg' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><i className="fa-solid fa-book-atlas"></i>Diccionario</button>
                                                                        <button onClick={() => (aiVersePanel && studyVerseId === activeV) ? setAiVersePanel(null) : handleSynthesis(txt)} className={`flex items-center justify-center gap-2 py-3.5 rounded-xl text-[10px] font-bold uppercase transition-all border ${(aiVersePanel && studyVerseId === activeV) ? 'bg-emerald-600 text-white border-emerald-600 shadow-lg' : 'bg-slate-50 text-slate-500 border-slate-200'}`}><i className="fa-solid fa-brain"></i>Estudio IA</button>
                                                                    </div>
                                                                    {showExegesisInput && (
                                                                        <div className="flex gap-2 mb-6 animate-slide-up bg-slate-50 p-1.5 rounded-xl border border-slate-100 items-center">
                                                                            <input autoFocus value={exegesisWord} onChange={e => setExegesisWord(e.target.value)} placeholder="Palabra clave..." className="flex-grow p-3 rounded-lg outline-none text-sm font-bold bg-transparent min-w-0" />
                                                                            <button onClick={() => handleExegesis(txt)} className="bg-emerald-600 text-white h-10 px-5 rounded-lg font-bold text-[10px] uppercase shadow-md transition-transform active:scale-95">Analizar</button>
                                                                        </div>
                                                                    )}
                                                                    {aiLoading && <div className="text-center py-4 text-emerald-500 animate-pulse font-bold uppercase text-[10px] tracking-widest flex items-center justify-center gap-3"><i className="fa-solid fa-sparkles"></i>Obteniendo revelación...</div>}
                                                                    {apiError && <div className="mb-6 p-4 text-rose-500 bg-rose-50 rounded-xl border border-rose-100 text-xs font-bold italic">{apiError}</div>}
                                                                    {exegesisList.length > 0 && studyVerseId === activeV && (
                                                                        <div className="animate-fade-in w-full border-t border-slate-100 pt-6 space-y-4">
                                                                            <div className="flex justify-between items-center px-1">
                                                                                <div className="flex items-center gap-2"><i className="fa-solid fa-book-atlas text-emerald-600 text-sm"></i><h3 className="text-[11px] font-bold text-slate-800 uppercase tracking-widest">Glosario IA</h3></div>
                                                                                <button onClick={() => setExegesisList([])} className="text-[9px] font-bold uppercase text-rose-400 tracking-tighter">Limpiar</button>
                                                                            </div>
                                                                            {exegesisList.map((item, idx) => (<div key={idx} className="space-y-1 animate-fade-in"><div className="flex items-center gap-2 ml-2 mb-2"><div className="w-1.5 h-1.5 rounded-full bg-emerald-500"></div><span className="text-xs font-bold text-slate-800 uppercase tracking-tighter">{item.word}</span></div><ExpertItem icon="fa-language" title="Original" text={item.original} color="emerald" /><ExpertItem icon="fa-book-open" title="Significado" text={item.significado} color="emerald" /></div>))}
                                                                        </div>
                                                                    )}
                                                                    {aiVersePanel && studyVerseId === activeV && (
                                                                        <div className="animate-fade-in w-full border-t border-slate-100 pt-6">
                                                                            <div className="flex justify-between items-center mb-5 px-1">
                                                                                <div className="flex items-center gap-2"><i className="fa-solid fa-brain text-emerald-600 text-sm"></i><h3 className="text-[11px] font-bold text-slate-800 uppercase tracking-widest">Estudio Profundo</h3></div>
                                                                                <button onClick={() => setAiVersePanel(null)} className="text-slate-300 hover:text-rose-400 transition-colors"><i className="fa-solid fa-xmark"></i></button>
                                                                            </div>
                                                                            <div className="space-y-1.5"><ExpertItem icon="fa-scroll" title="Teólogo" text={aiVersePanel.teologo} color="blue" /><ExpertItem icon="fa-landmark" title="Historiador" text={aiVersePanel.historiador} color="amber" /><ExpertItem icon="fa-hands-praying" title="Pastor" text={aiVersePanel.pastor} color="emerald" /><ExpertItem icon="fa-link" title="Referencias" text={aiVersePanel.referencias} color="indigo" /></div>
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {view === 'assistant' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                <SectionHeader title="Asistente Bíblico" onClose={closeToReading}>
                                    <button onClick={() => { setAsstQuery(""); setAsstResponses({ 'teólogo': '', 'historiador': '', 'pastor': '' }); }} className="w-9 h-9 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full hover:text-rose-500 active:scale-95 transition-all"><i className="fa-solid fa-trash-can text-sm"></i></button>
                                </SectionHeader>
                                <div className="space-y-8">
                                    <div className="flex bg-white p-1.5 rounded-2xl shadow-sm border">{['teólogo','historiador','pastor'].map(r => (<button key={r} onClick={() => setAsstRole(r)} className={`flex-1 py-3.5 rounded-xl font-bold text-[11px] uppercase transition-all tracking-widest ${asstRole === r ? 'bg-emerald-600 text-white shadow-lg' : 'text-slate-400'}`}>{r}</button>))}</div>
                                    <div className="relative group">
                                        <textarea value={asstQuery} onChange={e => setAsstQuery(e.target.value)} placeholder={`Escribe tu pregunta para el ${asstRole}...`} className="w-full p-6 rounded-[2rem] outline-none border-2 border-slate-100 bg-white min-h-[160px] text-lg font-medium shadow-sm transition-all focus:border-emerald-500/50" />
                                        <button onClick={handleAssistantAsk} className="absolute bottom-6 right-6 w-14 h-14 bg-emerald-600 text-white rounded-2xl shadow-xl shadow-emerald-600/20 active:scale-90 flex items-center justify-center transition-all"><i className={aiLoading ? "fa-solid fa-circle-notch fa-spin text-xl" : "fa-solid fa-wand-magic-sparkles text-xl"}></i></button>
                                    </div>
                                    <div className="px-2"><p className="text-xs text-slate-400 italic leading-relaxed"><i className="fa-solid fa-circle-info mr-2 text-emerald-500/50"></i>Pregunta sobre cualquier pasaje o concepto. Recibirás una respuesta personalizada de acuerdo al perfil seleccionado.</p></div>
                                    {asstResponses[asstRole] && (
                                        <div className="p-8 bg-white rounded-[2.5rem] shadow-xl border text-[17px] leading-relaxed whitespace-pre-wrap animate-slide-up">
                                            <div className="flex items-center gap-2 mb-6 text-[10px] font-bold uppercase text-emerald-600/50 tracking-[0.2em]"><i className="fa-solid fa-comment-dots"></i><span>Respuesta de la IA</span></div>
                                            <div className="font-medium text-slate-700"><LinkifiedText content={asstResponses[asstRole]} /></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'nav' && (
                            <div className="animate-fade-in w-full px-6 pt-2 pb-32">
                                <SectionHeader title="Biblioteca" onClose={closeToReading}>
                                    <button onClick={() => setNavSearchQ("")} className="w-9 h-9 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full hover:text-rose-500 active:scale-95 transition-all"><i className="fa-solid fa-trash-can text-sm"></i></button>
                                    <button onClick={() => setShowNavFilters(!showNavFilters)} className={`w-9 h-9 flex items-center justify-center rounded-full border transition-all ${showNavFilters ? 'bg-emerald-600 text-white border-emerald-600 shadow-md' : 'text-slate-400 border-slate-200'}`}><i className="fa-solid fa-sliders text-sm"></i></button>
                                </SectionHeader>
                                
                                <div className="relative mb-6">
                                    <input 
                                        value={navSearchQ} 
                                        onChange={e => setNavSearchQ(e.target.value)} 
                                        placeholder="Buscar un libro..." 
                                        className="w-full p-4 text-base rounded-2xl bg-white border border-slate-100 outline-none focus:border-emerald-500/50 shadow-sm" 
                                    />
                                </div>

                                {showNavFilters && (
                                    <div className="mb-8 p-6 rounded-[2rem] bg-white animate-slide-up border shadow-xl space-y-4">
                                        <p className="text-[10px] font-bold uppercase text-slate-400 tracking-widest px-1">Filtrar por Testamento</p>
                                        <div className="flex bg-slate-50 p-1 rounded-xl border">
                                            <button onClick={() => setNavTestamentFilter("todos")} className={`flex-1 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all ${navTestamentFilter === 'todos' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>Todos</button>
                                            <button onClick={() => setNavTestamentFilter("Antiguo Testamento")} className={`flex-1 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all ${navTestamentFilter === 'Antiguo Testamento' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>Antiguo</button>
                                            <button onClick={() => setNavTestamentFilter("Nuevo Testamento")} className={`flex-1 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all ${navTestamentFilter === 'Nuevo Testamento' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>Nuevo</button>
                                        </div>
                                        <button onClick={() => setShowNavFilters(false)} className="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold uppercase text-[10px] shadow-lg">Listo</button>
                                    </div>
                                )}

                                {lastPosition && !navSearchQ && navTestamentFilter === "todos" && (
                                    <div onClick={() => { setCurrentChapter({book: lastPosition.book, chapter: lastPosition.chapter}); setView('reading'); setTimeout(() => { handleToggleVerse(`${lastPosition.book}-${lastPosition.chapter}-${lastPosition.verse}`); }, 300); }} className="mb-6 p-5 rounded-[2rem] bg-emerald-600 text-white shadow-lg shadow-emerald-600/20 active:scale-[0.98] transition-all relative overflow-hidden cursor-pointer group animate-slide-up">
                                        <div className="absolute -top-6 -right-6 opacity-10 text-white text-8xl group-hover:rotate-12 transition-transform"><i className="fa-solid fa-bookmark"></i></div>
                                        <div className="relative z-10 flex items-center justify-between">
                                            <div>
                                                <p className="text-[10px] font-bold uppercase opacity-80 tracking-widest mb-1">Continuar lectura</p>
                                                <h3 className="text-xl font-black">{lastPosition.book} {lastPosition.chapter}:{lastPosition.verse}</h3>
                                            </div>
                                            <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm group-hover:bg-white group-hover:text-emerald-600 transition-colors">
                                                <i className="fa-solid fa-arrow-right text-sm"></i>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                <div className="space-y-6">
                                    {filteredNavStructure.length === 0 ? (
                                        <div className="py-20 text-center text-slate-400 italic">No se encontraron libros con esos criterios.</div>
                                    ) : filteredNavStructure.map((section, sIdx) => (
                                        <div key={sIdx} className="space-y-4">
                                            <h3 className="px-2 text-[10px] font-black uppercase text-slate-400 tracking-[0.2em] sticky top-0 bg-yvGrey-50/95 backdrop-blur-sm py-2 z-20 border-b border-slate-200/50">{section.title}</h3>
                                            {section.groups.map((group, gIdx) => (
                                                <div key={gIdx}>
                                                    <h4 className="px-2 mb-2 text-xs font-bold text-emerald-600 uppercase tracking-wider">{group.name}</h4>
                                                    <div className="grid grid-cols-1 gap-4 mb-6">
                                                        {group.books.map(book => {
                                                            const isLoaded = bibleData[book.id];
                                                            const progress = getBookProgress(book.id);
                                                            const isExp = expandedBook === book.id;
                                                            
                                                            return (
                                                                <div key={book.id} className="flex flex-col gap-2">
                                                                    <button onClick={() => setExpandedBook(isExp ? null : book.id)} className={`w-full p-5 rounded-2xl border transition-all text-left relative overflow-hidden ${isExp ? (isLoaded ? 'bg-emerald-600 border-emerald-600 text-white shadow-lg' : 'bg-slate-100 border-slate-200 text-slate-400') : (isLoaded ? 'bg-white border-slate-100 text-slate-700 shadow-sm' : 'bg-white border-dashed border-slate-200 text-slate-400 opacity-60 hover:opacity-100')}`}>
                                                                        <div className="flex justify-between items-center mb-2.5 relative z-10">
                                                                            <span className={`font-bold text-base ${!isLoaded && 'italic'}`}>{book.id}</span>
                                                                            <div className="flex items-center gap-3">
                                                                                {isLoaded && <span className={`text-[10px] font-black uppercase ${isExp ? 'text-white/60' : progress === 100 ? 'text-emerald-500' : 'text-slate-300'}`}>{progress}%</span>}
                                                                                <i className={`fa-solid ${isExp ? 'fa-chevron-up' : 'fa-chevron-down'} text-[10px] opacity-40`}></i>
                                                                            </div>
                                                                        </div>
                                                                        <div className={`w-full h-1 rounded-full overflow-hidden relative z-10 ${isExp ? 'bg-white/20' : 'bg-slate-100'}`}>
                                                                            <div className={`h-full transition-all duration-700 ${isExp ? 'bg-white' : 'bg-emerald-50'}`} style={{ width: `${progress}%` }}></div>
                                                                        </div>
                                                                    </button>
                                                                    {isExp && (
                                                                        <div className="grid grid-cols-5 sm:grid-cols-7 gap-2.5 p-5 bg-white rounded-2xl border border-slate-100 animate-slide-up shadow-inner">
                                                                            {Array.from({length: book.ch}, (_, i) => i + 1).map(c => {
                                                                                const isCompleted = readStatus[`${book.id}-${c}`];
                                                                                
                                                                                if (isLoaded) {
                                                                                    return (
                                                                                        <button key={c} onClick={() => { setCurrentChapter({book: book.id, chapter: c}); setExpandedBook(null); setView('reading'); }} className={`aspect-square relative rounded-xl text-[13px] font-bold flex items-center justify-center transition-all active:scale-90 ${isCompleted ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/20' : 'bg-slate-50 text-slate-500 border border-slate-100'}`}>
                                                                                            {c}
                                                                                            {isCompleted && <i className="fa-solid fa-check absolute top-1 right-1 text-[7px]"></i>}
                                                                                        </button>
                                                                                    );
                                                                                } else {
                                                                                    return (
                                                                                        <button key={c} onClick={() => setMissingBook(book.id)} className="aspect-square relative rounded-xl text-[13px] font-bold flex items-center justify-center bg-slate-300 text-white bg-slate-50 border border-dashed border-slate-200 cursor-help hover:border-emerald-200 transition-colors">
                                                                                            {c}
                                                                                        </button>
                                                                                    );
                                                                                }
                                                                            })}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'plans' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                {activePlan ? (
                                    <div className="animate-slide-up">
                                        <div className="flex justify-between items-center mb-6 px-1"><button onClick={() => setActivePlan(null)} className="flex items-center gap-2 text-emerald-600 font-bold uppercase text-[10px] tracking-widest"><i className="fa-solid fa-arrow-left"></i> Volver</button><button onClick={closeToReading} className="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 text-slate-400"><i className="fa-solid fa-xmark text-lg"></i></button></div>
                                        <div className="p-8 rounded-[2.5rem] bg-white shadow-xl border mb-8 relative overflow-hidden">
                                            <span className="absolute top-4 right-6 text-[9px] font-bold uppercase text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">{activePlan.category} • {activePlan.duration} días</span>
                                            <div className="flex items-center gap-5 mb-5 pr-10">
                                                <div className="w-16 h-16 rounded-[1.5rem] bg-emerald-50 flex items-center justify-center text-emerald-600"><i className="fa-solid fa-book-bookmark text-2xl"></i></div>
                                                <h3 className="font-black text-2xl text-slate-800 leading-tight flex-1">{activePlan.title}</h3>
                                            </div>
                                            <p className="text-slate-500 text-[15px] leading-relaxed">{activePlan.desc}</p>
                                        </div>
                                        <div className="space-y-3.5">
                                            {Array.from({ length: activePlan.duration }).map((_, i) => {
                                                const isCompleted = (planProgress[activePlan.id] || []).includes(i);
                                                return (<div key={i} className={`p-5 rounded-2xl border-2 flex items-center justify-between transition-all ${isCompleted ? 'bg-emerald-50/50 border-emerald-500/20' : 'bg-white border-transparent'}`}><div className="flex items-center gap-4"><button onClick={() => togglePlanDay(activePlan.id, i)} className={`w-7 h-7 rounded-full border-2 flex items-center justify-center transition-all ${isCompleted ? 'bg-emerald-500 border-emerald-500 text-white' : 'border-slate-100'}`}>{isCompleted && <i className="fa-solid fa-check text-[11px]"></i>}</button><div><span className={`text-[13px] font-bold ${isCompleted ? 'text-emerald-700' : 'text-slate-400'}`}>Día {i + 1}</span><p className="text-[10px] font-semibold text-slate-400 uppercase tracking-tighter">Lectura diaria</p></div></div><button onClick={() => { const book = activePlan.custom ? (activePlan.days?.[i]?.b || activePlan.bookRef) : activePlan.bookRef; const cap = activePlan.custom ? (activePlan.days?.[i]?.c || 1) : (i % 22 + 1); if (bibleData[book]) { setCurrentChapter({book, chapter: cap}); setView('reading'); } else { setMissingBook(book); } }} className={`px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase transition-all shadow-sm ${isCompleted ? 'bg-white text-emerald-600' : 'bg-emerald-600 text-white'}`}>Leer ahora</button></div>);
                                            })}
                                        </div>
                                    </div>
                                ) : (
                                    <>
                                        <SectionHeader title="Planes y Devocionales" onClose={closeToReading} />
                                        <div className="mb-10 p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-sm relative overflow-hidden group">
                                            <div className="absolute top-0 right-0 p-10 opacity-[0.03] text-slate-900 pointer-events-none group-hover:scale-110 transition-transform duration-1000"><i className="fa-solid fa-wand-magic-sparkles text-[10rem]"></i></div>
                                            <div className="flex items-center gap-4 mb-3 relative z-10"><i className="fa-solid fa-sparkles text-xl text-emerald-600"></i><h3 className="font-black text-2xl text-slate-800 flex-1">Generar Devocional&nbsp;IA</h3></div>
                                            <p className="text-slate-500 text-[15px] mb-6 leading-relaxed relative z-10">Cuéntame cómo te sientes o sobre qué tema quieres aprender, y crearé un plan de 7 días solo para ti.</p>
                                            <div className="flex gap-2.5 relative z-10">
                                                <input value={iaEmotion} onChange={e => setIaEmotion(e.target.value)} placeholder="Ej: Busco paz en la tormenta..." className="flex-grow p-4 rounded-xl bg-slate-50 border border-slate-100 outline-none text-base font-bold text-slate-700 placeholder:text-slate-300 focus:bg-white focus:border-emerald-500/30 transition-all" />
                                                <button onClick={handleGenerateSituationalPlan} disabled={aiLoading} className="bg-emerald-600 text-white w-14 h-14 rounded-xl shadow-lg active:scale-90 transition-all disabled:opacity-50 flex items-center justify-center"><i className={aiLoading ? "fa-solid fa-circle-notch fa-spin" : "fa-solid fa-plus"}></i></button>
                                            </div>
                                        </div>
                                        <h3 className="text-[10px] font-bold uppercase text-slate-400 mb-5 tracking-[0.2em] px-1">Planes Sugeridos</h3>
                                        <div className="grid gap-5">
                                            {PREDEFINED_PLANS.map(plan => (
                                                <div key={plan.id} onClick={() => setActivePlan(plan)} className="p-6 rounded-[2rem] bg-white border border-slate-100 shadow-sm relative overflow-hidden active:scale-[0.99] transition-all group cursor-pointer hover:shadow-md">
                                                    <div className="absolute -top-4 -right-4 opacity-[0.03] text-slate-900 text-8xl group-hover:rotate-6 transition-transform"><i className="fa-solid fa-bookmark"></i></div>
                                                    <span className="absolute top-4 right-6 text-[8px] font-black uppercase text-slate-500">{plan.category}</span>
                                                    <div className="flex items-center gap-4 mb-4">
                                                        <div className="w-12 h-12 shrink-0 rounded-2xl bg-slate-50 flex items-center justify-center text-emerald-600 group-hover:bg-emerald-600 group-hover:text-white transition-all"><i className={`fa-solid ${plan.icon} text-lg`}></i></div>
                                                        <h4 className="font-bold text-lg text-slate-800 leading-tight flex-1">{plan.title}</h4>
                                                    </div>
                                                    <p className="text-slate-400 text-sm mb-4 line-clamp-2 leading-relaxed">{plan.desc}</p>
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">{plan.duration} días</span>
                                                        <button className="text-emerald-600 font-black text-[10px] uppercase tracking-tighter">Ver más <i className="fa-solid fa-chevron-right ml-1"></i></button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        {view === 'favorites' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                <SectionHeader title="Favoritos" onClose={closeToReading}>
                                    <button onClick={() => setFavSearchQ("")} className="w-9 h-9 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full hover:text-rose-500 active:scale-95 transition-all"><i className="fa-solid fa-trash-can text-sm"></i></button>
                                    <button onClick={() => setShowFavFilters(!showFavFilters)} className={`w-9 h-9 flex items-center justify-center rounded-full border transition-all ${showFavFilters ? 'bg-emerald-600 text-white border-emerald-600' : 'text-slate-400 border-slate-200'}`}><i className="fa-solid fa-sliders text-sm"></i></button>
                                </SectionHeader>
                                <div className="flex gap-3 mb-6">
                                    <div className="relative flex-grow">
                                        <input value={favSearchQ} onChange={e => setFavSearchQ(e.target.value)} placeholder="Busca en tus marcadores..." className="w-full p-4 pr-12 text-base rounded-2xl bg-white border border-slate-100 outline-none focus:border-emerald-500/50 shadow-sm" />
                                        <i className="fa-solid fa-magnifying-glass absolute right-4 top-1/2 -translate-y-1/2 text-slate-300"></i>
                                    </div>
                                    <select value={favSortOrder} onChange={e => setFavSortOrder(e.target.value)} className="bg-white text-slate-500 px-3 rounded-2xl text-[11px] font-medium outline-none border border-slate-100 shadow-sm"><option value="reciente">Reciente</option><option value="biblico">Bíblico</option></select>
                                </div>
                                {showFavFilters && (
                                    <div className="mb-8 p-8 rounded-[2.5rem] bg-white shadow-xl border space-y-6 animate-slide-up">
                                        <div className="grid grid-cols-2 gap-5">
                                            <div><p className="text-[10px] font-bold uppercase text-slate-400 mb-2.5">Filtrar Libro</p><select value={favBook} onChange={e => setFavBook(e.target.value)} className="w-full p-3.5 rounded-xl bg-slate-50 border text-sm outline-none"><option value="todos">Cualquier libro</option>{favBooksInList.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                            <div><p className="text-[10px] font-bold uppercase text-slate-400 mb-2.5">Testamento</p><select value={favTestament} onChange={e => setFavTestament(e.target.value)} className="w-full p-3.5 rounded-xl bg-slate-50 border text-sm outline-none"><option value="todos">Toda la Biblia</option><option value="antiguo">Antiguo</option><option value="nuevo">Nuevo</option></select></div>
                                        </div>
                                        <div><p className="text-[10px] font-bold uppercase text-slate-400 mb-2.5">Búsqueda por</p><div className="flex bg-slate-50 p-1 rounded-xl border"><button onClick={() => setFavMatchType("frase")} className={`flex-1 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all ${favMatchType === 'frase' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>Frase</button><button onClick={() => setFavMatchType("palabras")} className={`flex-1 py-2.5 text-[10px] font-bold uppercase rounded-lg transition-all ${favMatchType === 'palabras' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400'}`}>Palabras</button></div></div>
                                        <button onClick={() => setShowFavFilters(false)} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold uppercase text-[11px] shadow-lg">Aplicar Filtros</button>
                                    </div>
                                )}
                                {filteredFavorites.length === 0 ? <div className="text-center py-20 text-slate-400 italic">No se encontraron favoritos. Guarda versículos mientras lees para verlos aquí.</div> : (
                                    <div className="space-y-4">
                                        {filteredFavorites.map(f => (
                                            <div key={f.id} className="p-6 rounded-3xl bg-white border border-slate-100 shadow-sm active:scale-[0.99] transition-all hover:shadow-md">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span onClick={() => { pushToStack(); setCurrentChapter({book: f.b, chapter: f.c}); setView('reading'); setTimeout(() => { handleToggleVerse(f.id); }, 400); }} className="text-[11px] font-black text-emerald-600 cursor-pointer tracking-widest uppercase hover:underline">{f.ref}</span>
                                                    <div className="flex gap-1.5"><button onClick={() => handleShare(f.text, f.ref)} className="p-2 text-slate-300 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-share-nodes text-base"></i></button><button onClick={() => toggleFav(f.id, f.text, f.ref, f.b, f.c)} className="p-2 text-rose-300 hover:text-rose-500 transition-colors"><i className="fa-solid fa-trash-can text-base"></i></button></div>
                                                </div>
                                                <p className="text-lg text-slate-700 font-medium leading-relaxed italic">"{f.text}"</p>
                                                {annotations[f.id]?.notes?.length > 0 && (<div className="mt-4 pt-4 border-t border-slate-50 space-y-3">{annotations[f.id].notes.map(n => (<div key={n.id} className="text-sm italic text-slate-400 flex gap-3"><i className="fa-solid fa-quote-left text-[10px] mt-1 text-emerald-500/30"></i><span>{n.text}</span></div>))}</div>)}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                <SectionHeader title={getSettingsTitle().toUpperCase()} onClose={closeToReading}>
                                    {settingsPart && (<button onClick={() => {setSettingsPart(null); setShowDeleteConfirm(false); setImportStatus("");}} className="text-emerald-600 font-bold text-[10px] uppercase tracking-widest"><i className="fa-solid fa-arrow-left mr-1"></i>Atrás</button>)}
                                </SectionHeader>
                                <div className="space-y-4">
                                    {!settingsPart ? (
                                        <div className="space-y-3.5">
                                            {[{id:'apariencia', icon:'fa-wand-magic-sparkles', title:'Apariencia', desc:'Estilos de lectura y fuentes.'},{id:'ia', icon:'fa-robot', title:'Configuración IA', desc:'Control de modelos y API Keys.'},{id:'backup', icon:'fa-cloud-arrow-up', title:'Copia de seguridad', desc:'Sincronización y resguardo de datos.'},{id:'biblioteca', icon:'fa-database', title:'Biblioteca', desc:'Gestión manual de libros y textos.'}].map(item => (<button key={item.id} onClick={() => setSettingsPart(item.id)} className="w-full p-6 rounded-2xl bg-white border border-slate-100 shadow-sm flex items-center gap-5 active:scale-[0.98] transition-all text-left group"><div className="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center text-slate-400 group-hover:bg-emerald-600 group-hover:text-white transition-all"><i className={`fa-solid ${item.icon} text-lg`}></i></div><div className="flex-1"><h3 className="font-bold text-base text-slate-800">{item.title}</h3><p className="text-xs text-slate-400 font-medium">{item.desc}</p></div><i className="fa-solid fa-chevron-right text-xs text-slate-200 group-hover:translate-x-1 transition-transform"></i></button>))}
                                        </div>
                                    ) : (
                                        <div className="animate-slide-up space-y-6">
                                            {settingsPart === 'apariencia' && (
                                                <div className="space-y-6">
                                                    <div className="p-8 rounded-[2rem] bg-white shadow-xl border border-slate-100"><div className="flex justify-between mb-8 items-center"><span className="text-[10px] font-bold uppercase tracking-widest text-slate-400">Tamaño del Texto</span><span className="text-lg font-black text-emerald-600">{fontSize}px</span></div><input type="range" min="14" max="44" value={fontSize} onInput={e => setFontSize(parseInt(e.target.value))} /></div>
                                                    <div className="p-8 rounded-[2rem] bg-white shadow-xl border border-slate-100"><p className="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-6 text-center">Fuentes de Lectura</p><div className="grid grid-cols-2 gap-4">{[{id:'sans', name:'Sans'},{id:'serif', name:'Serif'},{id:'mono', name:'Mono'},{id:'slab', name:'Slab'}].map(f => (<button key={f.id} onClick={() => setFontFamily(f.id)} className={`py-4 rounded-xl border-2 transition-all ${fontFamily === f.id ? 'border-emerald-500 bg-emerald-50 text-emerald-600 shadow-md' : 'border-slate-50 text-slate-400 hover:border-slate-200'}`}><span className={`font-reading-${f.id} text-lg font-bold`}>{f.name}</span></button>))}</div></div>
                                                </div>
                                            )}
                                            {settingsPart === 'ia' && (
                                                <div className="p-8 rounded-[2rem] bg-white shadow-xl border border-slate-100 text-center">
                                                    <div className="flex items-center gap-3 mb-6 justify-center text-[10px] font-bold uppercase tracking-[0.2em] text-emerald-600">
                                                        <i className="fa-solid fa-key"></i>
                                                        <span>Acceso API Gemini</span>
                                                        {userApiKey && <i className="fa-solid fa-circle-check text-emerald-500 animate-fade-in"></i>}
                                                    </div>
                                                    <input 
                                                        type="password" 
                                                        value={userApiKey} 
                                                        onChange={e => {
                                                            const newKey = e.target.value;
                                                            setUserApiKey(newKey);
                                                            if(newKey.trim()){
                                                                setImportStatus("API Key registrada correctamente");
                                                            } else {
                                                                setImportStatus("");
                                                            }
                                                        }} 
                                                        placeholder="Introduce tu clave privada..." 
                                                        className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 outline-none text-center text-emerald-600 font-reading-sans text-sm transition-all" 
                                                    />
                                                    {importStatus && (
                                                        <div className={`mt-4 p-3 rounded-xl text-[10px] font-bold uppercase tracking-wider animate-fade-in ${importStatus.startsWith('Error') ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                                                            <i className={`fa-solid ${importStatus.startsWith('Error') ? 'fa-circle-exclamation' : 'fa-check'} mr-2`}></i>
                                                            {importStatus}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            {settingsPart === 'backup' && (
                                                <div className="p-8 rounded-[2rem] bg-white shadow-xl border border-slate-100 space-y-4 text-center">
                                                    <div className="grid grid-cols-1 gap-3">
                                                        <button onClick={handleExportBackup} className="w-full py-4 bg-emerald-50 text-emerald-600 rounded-xl font-bold uppercase text-xs shadow-sm flex items-center justify-center gap-3 hover:bg-emerald-100 transition-colors">
                                                            <i className="fa-solid fa-download"></i> Crear Backup
                                                        </button>
                                                        <button onClick={() => backupInputRef.current.click()} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold uppercase text-xs shadow-lg flex items-center justify-center gap-3 active:scale-95 transition-transform">
                                                            <i className="fa-solid fa-upload"></i> Restaurar
                                                        </button>
                                                        <input ref={backupInputRef} type="file" accept=".json" onChange={handleImportBackup} className="hidden" />
                                                    </div>
                                                    
                                                    {importStatus && (
                                                        <div className={`mt-4 p-3 rounded-xl text-[10px] font-bold uppercase tracking-wider animate-fade-in ${importStatus.startsWith('Error') ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                                                            <i className={`fa-solid ${importStatus.startsWith('Error') ? 'fa-circle-exclamation' : 'fa-check'} mr-2`}></i>
                                                            {importStatus}
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            {settingsPart === 'biblioteca' && (
                                                <div className="p-8 rounded-[2rem] bg-white shadow-xl border border-slate-100 space-y-6">
                                                    <div className="space-y-4">
                                                        <button onClick={() => fileInputRef.current.click()} className="w-full py-4 bg-emerald-50 text-emerald-600 rounded-xl font-bold uppercase text-xs shadow-sm flex items-center justify-center gap-3 hover:bg-emerald-100 transition-colors">
                                                            <i className="fa-solid fa-file-arrow-up"></i> Elegir archivo (.json, .txt)
                                                        </button>
                                                        <input ref={fileInputRef} type="file" accept=".json,.txt,.sql" onChange={handleFileUpload} className="hidden" />
                                                        <div className="relative"><select value={manualBookSelect} onChange={e => setManualBookSelect(e.target.value)} className="w-full p-4 rounded-xl bg-slate-50 border border-slate-100 focus:border-emerald-500 outline-none text-sm font-bold text-slate-600 appearance-none shadow-sm transition-all"><option value="" disabled>Selecciona el libro...</option>{CANONICAL_ORDER.map(b => <option key={b} value={b}>{b}</option>)}</select><i className="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs"></i></div>
                                                        <textarea value={importText} onChange={e => setImportText(e.target.value)} placeholder='Pega aquí el texto bíblico...' className="w-full p-5 rounded-xl bg-slate-50 border border-slate-100 outline-none font-medium text-sm text-slate-700 min-h-[180px] focus:border-emerald-500 focus:ring-2 focus:ring-emerald-100 transition-all shadow-inner placeholder:text-slate-300" />
                                                        <div className="flex gap-2">
                                                            <button onClick={() => setImportText("")} className="w-14 h-14 bg-slate-100 text-slate-400 rounded-xl font-bold uppercase text-xs active:scale-95 transition-all flex items-center justify-center shrink-0 hover:bg-slate-200" title="Borrar texto"><i className="fa-solid fa-eraser text-lg"></i></button>
                                                            <button onClick={() => { setImportStatus(""); processImport(importText); }} className="flex-grow bg-gradient-to-r from-emerald-600 to-emerald-500 text-white py-4 rounded-xl font-bold uppercase text-xs shadow-lg shadow-emerald-500/30 active:scale-95 transition-all flex items-center justify-center gap-2"><i className="fa-solid fa-cloud-arrow-up"></i> Cargar Textos</button>
                                                        </div>
                                                    </div>

                                                    {importStatus && (
                                                        <div className={`mt-4 p-3 rounded-xl text-[10px] font-bold uppercase tracking-wider text-center animate-fade-in ${importStatus.startsWith('Error') ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}`}>
                                                            <i className={`fa-solid ${importStatus.startsWith('Error') ? 'fa-circle-exclamation' : 'fa-check'} mr-2`}></i>
                                                            {importStatus}
                                                        </div>
                                                    )}

                                                    <div className="pt-6 border-t border-slate-100">
                                                        {showDeleteConfirm ? (
                                                            <div className="bg-rose-50 p-6 rounded-2xl border border-rose-200 text-center animate-fade-in">
                                                                <p className="text-[10px] font-black uppercase text-rose-600 mb-4 tracking-widest"><i className="fa-solid fa-triangle-exclamation mr-2"></i>¿Confirmas borrar todo?</p>
                                                                <div className="flex gap-3">
                                                                    <button onClick={() => setShowDeleteConfirm(false)} className="flex-1 py-3 bg-white rounded-xl text-xs font-bold shadow-sm text-slate-500">Cancelar</button>
                                                                    <button onClick={async () => { setBibleData({}); await db.set('bible_content', {}); setCurrentChapter({book:'', chapter:1}); setShowDeleteConfirm(false); setImportStatus("Biblioteca vaciada"); }} className="flex-1 py-3 bg-rose-500 text-white rounded-xl text-xs font-bold shadow-md shadow-rose-500/20">Sí, borrar</button>
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <button onClick={() => setShowDeleteConfirm(true)} className="w-full py-4 text-rose-400 hover:text-rose-500 font-bold uppercase text-[10px] tracking-widest transition-colors flex items-center justify-center gap-2"><i className="fa-solid fa-trash-can"></i> Vacíar Biblioteca</button>
                                                        )}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'search' && (
                            <div className="animate-fade-in px-6 pt-2 pb-32">
                                <SectionHeader title="Buscador" onClose={closeToReading}>
                                    <button onClick={() => { setSearchQ(""); setSearchRes([]); setAiSummary(""); }} className="w-9 h-9 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full hover:text-rose-500 active:scale-95 transition-all"><i className="fa-solid fa-trash-can text-sm"></i></button>
                                    <button onClick={() => setShowSearchFilters(!showSearchFilters)} className={`w-9 h-9 flex items-center justify-center rounded-full border transition-all ${showSearchFilters ? 'bg-emerald-600 text-white border-emerald-600 shadow-md' : 'text-slate-400 border-slate-200'}`}><i className="fa-solid fa-sliders-h text-sm"></i></button>
                                </SectionHeader>
                                <div className="flex gap-2.5 mb-6">
                                    <div className="relative flex-grow">
                                        <input 
                                            value={searchQ} 
                                            onChange={e => setSearchQ(e.target.value)} 
                                            onKeyDown={e => e.key === 'Enter' && handleSearch()} 
                                            placeholder="Palabras o temas espirituales..." 
                                            className="w-full p-4 text-base rounded-2xl bg-white border border-slate-100 outline-none focus:border-emerald-500/50 shadow-sm" 
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleSearch()} 
                                        className="bg-emerald-50 text-emerald-600 border border-emerald-100 w-14 h-14 rounded-2xl shadow-sm active:scale-90 transition-all flex items-center justify-center shrink-0"
                                        title="Búsqueda exacta"
                                    >
                                        <i className="fa-solid fa-magnifying-glass text-lg"></i>
                                    </button>
                                    <button 
                                        onClick={() => handleConceptualSearch()} 
                                        disabled={aiLoading} 
                                        className="bg-emerald-600 text-white w-14 h-14 rounded-2xl shadow-xl shadow-emerald-600/20 active:scale-90 transition-all flex items-center justify-center shrink-0"
                                        title="Búsqueda con IA"
                                    >
                                        <i className={aiLoading ? "fa-solid fa-circle-notch fa-spin text-lg" : "fa-solid fa-brain text-lg"}></i>
                                    </button>
                                </div>

                                {showSearchFilters && (
                                    <div className="mb-8 p-8 rounded-[2.5rem] bg-white animate-slide-up border shadow-xl space-y-6">
                                        <div className="grid grid-cols-2 gap-5">
                                            <div><p className="text-[10px] font-bold uppercase text-slate-400 mb-2.5">Filtrar Libro</p><select value={searchBook} onChange={e => setSearchBook(e.target.value)} className="w-full p-3.5 rounded-xl bg-slate-50 border text-sm outline-none"><option value="todos">Todos</option>{booksList.map(b => <option key={b} value={b}>{b}</option>)}</select></div>
                                            <div><p className="text-[10px] font-bold uppercase text-slate-400 mb-2.5">Testamento</p><select value={searchTestamentState} onChange={e => setSearchTestament(e.target.value)} className="w-full p-3.5 rounded-xl bg-slate-50 border text-sm outline-none"><option value="todos">Todos</option><option value="antiguo">Antiguo</option><option value="nuevo">Nuevo</option></select></div>
                                        </div>
                                        <button onClick={handleSearch} className="w-full py-4 bg-emerald-600 text-white rounded-xl font-bold uppercase text-xs shadow-lg active:scale-95 transition-all">Búsqueda por palabras</button>
                                    </div>
                                )}

                                <div className="flex flex-wrap gap-1.5 mb-8 overflow-x-auto no-scrollbar pb-1">
                                    {SEARCH_TAGS.map(tag => (
                                        <button key={tag} onClick={() => handleConceptualSearch(tag)} className="px-3 py-2 bg-white text-slate-500 rounded-full text-[10px] font-bold uppercase border border-slate-100 whitespace-nowrap active:scale-95 transition-all shadow-sm"># {tag}</button>
                                    ))}
                                </div>
                                
                                <div className="mb-8 px-2 space-y-2">
                                    <p className="text-[13px] text-slate-400 italic leading-relaxed">
                                        <i className="fa-solid fa-magnifying-glass mr-2 text-emerald-500/50"></i>
                                        <b>Lupa:</b> Encuentra versículos que contengan las palabras exactas que escribas.
                                    </p>
                                    <p className="text-[13px] text-slate-400 italic leading-relaxed">
                                        <i className="fa-solid fa-brain mr-2 text-emerald-500/50"></i>
                                        <b>Cerebro:</b> La IA buscará por temas, sentimientos o descripciones (ej: "Jesús calma la tormenta").
                                    </p>
                                </div>

                                {aiSummary && (
                                    <div className="mb-10 p-8 bg-emerald-50/50 border border-emerald-100 text-slate-800 rounded-[2.5rem] shadow-sm animate-slide-up relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-8 opacity-[0.05] group-hover:scale-110 transition-transform duration-1000 text-[8rem] pointer-events-none text-emerald-600"><i className="fa-solid fa-sparkles"></i></div>
                                        <span className="text-[9px] font-bold uppercase tracking-[0.2em] text-emerald-600/60 block mb-3">Revelación&nbsp;IA</span>
                                        <p className="text-lg font-medium leading-relaxed relative z-10 text-slate-700"><LinkifiedText content={aiSummary} /></p>
                                    </div>
                                )}
                                <div className="space-y-4">
                                    {searchRes.length > 0 ? searchRes.map((r, i) => (
                                        <div key={i} onClick={() => { if (bibleData[r.b]) { pushToStack(); setCurrentChapter({book:r.b, chapter:r.c}); setView('reading'); setTimeout(() => { handleToggleVerse(`${r.b}-${r.c}-${r.v}`); }, 400); } else setMissingBook(r.b); }} className="p-6 rounded-[1.8rem] bg-white border border-slate-100 shadow-sm active:scale-[0.99] transition-all hover:shadow-md cursor-pointer">
                                            <div className="flex justify-between items-center mb-3"><span className="text-[10px] font-black italic text-emerald-600 tracking-widest uppercase">{r.b} {r.c}:{r.v}</span></div>
                                            <p className="text-[17px] text-slate-800 font-medium leading-relaxed"><LinkifiedText content={r.t} /></p>
                                            {r.iaComment && <p className="mt-4 text-xs italic text-slate-500 border-t pt-4 leading-relaxed"><i className="fa-solid fa-lightbulb mr-2 text-emerald-500/50"></i><LinkifiedText content={r.iaComment} /></p>}
                                        </div>
                                    )) : searchQ && !aiLoading && <div className="text-center py-10 text-slate-400 italic">No se encontraron resultados literales.</div>}
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className={`fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-100 z-50 px-4 md:max-w-3xl md:mx-auto flex items-center justify-between transition-transform duration-300 ${showUI ? 'translate-y-0' : 'translate-y-full'}`}
                         style={{ height: 'calc(4rem + var(--sab))', paddingBottom: 'var(--sab)' }}>
                        <NavItem v="home" i="fa-house" l="Inicio" />
                        <NavItem v="reading" i="fa-bible" l="Biblia" />
                        <NavItem v="search" i="fa-search" l="Buscar" />
                        <NavItem v="assistant" i="fa-wand-magic-sparkles" l="Asistente" />
                        <NavItem v="plans" i="fa-calendar-check" l="Planes" />
                        <NavItem v="favorites" i="fa-bookmark" l="Favs" />
                        <NavItem v="settings" i="fa-gear" l="Ajustes" />
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


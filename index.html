<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Biblia Interactiva Pro</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { slate: { 950: '#020617' } },
                    animation: {
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .highlight-yellow { background-color: #fef9c3; border-left: 4px solid #facc15; } 
        .highlight-green { background-color: #dcfce7; border-left: 4px solid #4ade80; }
        .highlight-blue { background-color: #dbeafe; border-left: 4px solid #60a5fa; }
        .highlight-red { background-color: #fee2e2; border-left: 4px solid #f87171; }
        .reading-active { background-color: #ffedd5 !important; border-left: 4px solid #f97316 !important; }

        .dark .highlight-yellow { background-color: #422006; border-left-color: #eab308; color: #fef08a; }
        .dark .highlight-green { background-color: #052e16; border-left-color: #22c55e; color: #bbf7d0; }
        .dark .highlight-blue { background-color: #172554; border-left-color: #3b82f6; color: #bfdbfe; }
        .dark .highlight-red { background-color: #450a0a; border-left-color: #ef4444; color: #fecaca; }
        .dark .reading-active { background-color: #431407 !important; color: #ffedd5; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #10b981; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(0,0,0,0.1); border-radius: 2px; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 h-screen overflow-hidden transition-colors duration-300">
    <div id="root" class="h-full flex justify-center w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- MOTOR IA INTERNO ---
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        async function callAI(prompt, systemInstruction = "Eres un erudito bÃ­blico. Responde de forma profunda y clara. Usa Markdown.") {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo obtener respuesta.";
            } catch (e) { return "Error de conexiÃ³n con el motor de IA."; }
        }

        // --- BASE DE DATOS ---
        const DB_CONFIG = { name: 'BibleFinalDB', version: 3, store: 'appData' };
        const db = {
            instance: null,
            init: () => new Promise(res => {
                const req = indexedDB.open(DB_CONFIG.name, DB_CONFIG.version);
                req.onupgradeneeded = e => {
                    const database = e.target.result;
                    if (!database.objectStoreNames.contains(DB_CONFIG.store)) database.createObjectStore(DB_CONFIG.store);
                };
                req.onsuccess = e => { db.instance = e.target.result; res(); };
            }),
            get: k => new Promise(res => {
                const tx = db.instance.transaction(DB_CONFIG.store, 'readonly');
                const req = tx.objectStore(DB_CONFIG.store).get(k);
                req.onsuccess = () => res(req.result);
            }),
            set: (k, v) => new Promise(res => {
                const tx = db.instance.transaction(DB_CONFIG.store, 'readwrite');
                const req = tx.objectStore(DB_CONFIG.store).put(v, k);
                req.onsuccess = () => res();
            })
        };

        const initialBible = {
            books: ['GÃ©nesis', 'Salmos', 'Juan', 'Romanos'],
            content: {
                'GÃ©nesis': { 1: ["En el principio creÃ³ Dios los cielos y la tierra.", "Y la tierra estaba desordenada y vacÃ­a...", "Y dijo Dios: Sea la luz; y fue la luz."] },
                'Salmos': { 1: ["Bienaventurado el varÃ³n...", "Sino que en la ley de JehovÃ¡...", "SerÃ¡ como Ã¡rbol plantado..."], 23: ["JehovÃ¡ es mi pastor; nada me faltarÃ¡.", "En lugares de delicados pastos me harÃ¡ descansar...", "ConfortarÃ¡ mi alma..."] },
                'Juan': { 1: ["En el principio era el Verbo...", "Todas las cosas por Ã©l fueron hechas...", "En Ã©l estaba la vida..."], 3: ["HabÃ­a un hombre de los fariseos...", "RespondiÃ³ JesÃºs y le dijo..."] },
                'Romanos': { 8: ["Ahora, pues, ninguna condenaciÃ³n hay...", "Porque la ley del EspÃ­ritu de vida..."] }
            }
        };

        const PREDEFINED_PLANS = [
            { id: 'devotional_1', title: 'Fundamentos de Fe', desc: 'Aprende los pilares del cristianismo.', days: [{b:'Juan', c:1}, {b:'Juan', c:3}, {b:'Romanos', c:8}] },
            { id: 'wisdom_1', title: 'Salmos de Esperanza', desc: 'Consuelo para momentos difÃ­ciles.', days: [{b:'Salmos', c:23}, {b:'Salmos', c:1}] }
        ];

        function App() {
            const [ready, setReady] = useState(false);
            const [view, setView] = useState('reading');
            const [bible, setBible] = useState(null);
            const [annotations, setAnnotations] = useState({});
            const [favorites, setFavorites] = useState([]);
            const [readStatus, setReadStatus] = useState({});
            
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('darkMode') === 'true');
            const [fontSize, setFontSize] = useState(() => parseInt(localStorage.getItem('fontSize')) || 18);
            const [loadedSegments, setLoadedSegments] = useState([]);
            
            const [navStep, setNavStep] = useState('books');
            const [navBook, setNavBook] = useState(null);
            
            const [activeV, setActiveV] = useState(null);
            const [noteInput, setNoteInput] = useState("");
            const [editingNote, setEditingNote] = useState({ vId: null, nId: null, text: "" });
            
            const [searchQ, setSearchQ] = useState("");
            const [searchRes, setSearchRes] = useState([]);
            
            const [aiLoad, setAiLoad] = useState(false);
            const [aiResp, setAiResp] = useState("");
            
            const [assistantPersona, setAssistantPersona] = useState('teologo'); 
            const [assistantQuery, setAssistantQuery] = useState("");
            const [assistantResponse, setAssistantResponse] = useState("");

            const synth = useRef(window.speechSynthesis);

            useEffect(() => {
                db.init().then(async () => {
                    const b = await db.get('bible') || initialBible;
                    const a = await db.get('annotations') || {};
                    const f = await db.get('favorites') || [];
                    const r = await db.get('readStatus') || {};
                    setBible(b); setAnnotations(a); setFavorites(f); setReadStatus(r);
                    setLoadedSegments([{ book: b.books[0], chapter: 1 }]);
                    setReady(true);
                });
            }, []);

            useEffect(() => {
                if (!ready) return;
                db.set('bible', bible); db.set('annotations', annotations);
                db.set('favorites', favorites); db.set('readStatus', readStatus);
                localStorage.setItem('darkMode', darkMode);
                localStorage.setItem('fontSize', fontSize);
                document.body.classList.toggle('dark', darkMode);
            }, [bible, annotations, favorites, readStatus, darkMode, fontSize, ready]);

            // Handlers
            const analyzeVerse = async (txt, ref) => {
                setAiLoad(true); setAiResp("");
                const res = await callAI(`Analiza este versÃ­culo detalladamente: "${txt}" (${ref}). Proporciona Contexto HistÃ³rico, Significado TeolÃ³gico y AplicaciÃ³n en puntos concretos.`);
                setAiResp(res); setAiLoad(false);
            };

            const toggleRead = (b, c) => {
                const id = `${b}-${c}`;
                setReadStatus(p => {
                    const n = { ...p };
                    if (n[id]) delete n[id]; else n[id] = new Date().toISOString();
                    return n;
                });
            };

            const runSearch = () => {
                const q = searchQ.toLowerCase();
                const res = [];
                bible.books.forEach(b => {
                    Object.keys(bible.content[b] || {}).forEach(c => {
                        bible.content[b][c].forEach((t, i) => {
                            if (t.toLowerCase().includes(q)) res.push({ b, c, v: i+1, t });
                        });
                    });
                });
                setSearchRes(res);
            };

            const addNote = (vId) => {
                if (!noteInput.trim()) return;
                setAnnotations(p => {
                    const cur = p[vId] || {};
                    const notes = cur.notes || [];
                    return { ...p, [vId]: { ...cur, notes: [...notes, { id: Date.now(), text: noteInput, date: new Date().toLocaleDateString() }] } };
                });
                setNoteInput("");
            };

            const saveEditedNote = () => {
                if (!editingNote.text.trim()) return;
                setAnnotations(p => {
                    const cur = p[editingNote.vId];
                    if (!cur) return p;
                    const updatedNotes = cur.notes.map(n => 
                        n.id === editingNote.nId ? { ...n, text: editingNote.text } : n
                    );
                    return { ...p, [editingNote.vId]: { ...cur, notes: updatedNotes } };
                });
                setEditingNote({ vId: null, nId: null, text: "" });
            };

            const handleAssistantInquiry = async () => {
                if (!assistantQuery.trim()) return;
                setAiLoad(true);
                setAssistantResponse("");
                
                let instruction = "";
                if (assistantPersona === 'teologo') {
                    instruction = `Eres un TEÃ“LOGO sistemÃ¡tico y acadÃ©mico. 
                        REGLAS DE RESPUESTA:
                        1. Usa un tono formal, erudito y analÃ­tico.
                        2. CÃ©ntrate en la doctrina, el dogma, la etimologÃ­a y la exÃ©gesis.
                        3. Menciona conceptos teolÃ³gicos complejos si es necesario.
                        4. Tu objetivo es explicar la "Verdad Doctrinal" detrÃ¡s de la consulta.`;
                } else if (assistantPersona === 'historiador') {
                    instruction = `Eres un HISTORIADOR bÃ­blico y arqueÃ³logo. 
                        REGLAS DE RESPUESTA:
                        1. Usa un tono puramente objetivo, cientÃ­fico y cronolÃ³gico.
                        2. CÃ©ntrate exclusivamente en el contexto del Antiguo Cercano Oriente o el mundo grecorromano.
                        3. Habla de polÃ­tica, economÃ­a, arqueologÃ­a y costumbres sociales de la Ã©poca.
                        4. NO des consejos espirituales ni hables de fe personal. Tu objetivo es el "Contexto Temporal".`;
                } else {
                    instruction = `Eres un PASTOR compasivo, empÃ¡tico y prÃ¡ctico. 
                        REGLAS DE RESPUESTA:
                        1. Usa un tono cÃ¡lido, cercano, amable y motivacional.
                        2. DirÃ­gete al usuario de "tÃº" y habla al corazÃ³n.
                        3. CÃ©ntrate en cÃ³mo aplicar la palabra a los problemas de hoy (estrÃ©s, familia, fe, esperanza).
                        4. Tu objetivo es el "Aliento Espiritual" y la guÃ­a de vida.`;
                }

                const res = await callAI(assistantQuery, instruction);
                setAssistantResponse(res);
                setAiLoad(false);
            };

            const calculateProgress = (plan) => {
                const completed = plan.days.filter(d => readStatus[`${d.b}-${d.c}`]).length;
                return Math.round((completed / plan.days.length) * 100);
            };

            const renderMD = (t) => t?.split('\n').map((l, i) => {
                if (l.startsWith('#') || l.startsWith('*')) {
                    const clean = l.replace(/[#*]/g,'').trim();
                    if (!clean) return null;
                    return <h4 key={i} className="font-bold text-emerald-600 dark:text-emerald-400 mt-5 mb-2 text-[12px] uppercase tracking-widest border-b border-emerald-500/10 pb-1">{clean}</h4>;
                }
                const bold = l.replace(/\*\*(.*?)\*\*/g, '<strong class="text-emerald-700 dark:text-emerald-400 font-bold">$1</strong>');
                if (!l.trim()) return null;
                return <p key={i} className="text-base leading-relaxed mb-3 opacity-95 text-slate-700 dark:text-slate-300" dangerouslySetInnerHTML={{ __html: bold }}></p>;
            });

            if (!ready) return null;

            return (
                <div className={`flex flex-col h-full w-full md:max-w-xl shadow-2xl overflow-hidden transition-colors duration-300 relative mx-auto ${darkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200'}`}>
                    
                    {/* CABEZAL */}
                    <header className={`${darkMode ? 'bg-emerald-950' : 'bg-emerald-600'} text-white p-3 shadow-md z-20 shrink-0`}>
                        <div className="flex justify-between items-center mb-2 px-1">
                            <h1 className="font-bold text-xl tracking-tight">Biblia Interactiva</h1>
                            <div className="flex gap-1 items-center">
                                <button onClick={() => setDarkMode(!darkMode)} title="Modo" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'} text-2xl`}></i>
                                </button>
                                <button onClick={() => setView('search')} title="Buscador" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className="fa-solid fa-magnifying-glass text-2xl"></i>
                                </button>
                                <button onClick={() => setView('plans')} title="Planes" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className="fa-solid fa-calendar-check text-2xl"></i>
                                </button>
                                <button onClick={() => setView('settings')} title="Ajustes" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className="fa-solid fa-gear text-2xl"></i>
                                </button>
                                <button onClick={() => setView('assistant')} title="Asistente" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className="fa-solid fa-robot text-2xl"></i>
                                </button>
                                <button onClick={() => setView('favorites')} title="Favoritos" className="w-11 h-11 flex items-center justify-center transition-all hover:bg-white/10 rounded-full">
                                    <i className="fa-solid fa-star text-2xl"></i>
                                </button>
                            </div>
                        </div>
                        <div className={`p-2 rounded-lg flex gap-2 items-center ${darkMode ? 'bg-slate-800' : 'bg-emerald-700'}`}>
                            <button onClick={() => { setView('navigation'); setNavStep('books'); }} className="flex-grow text-left px-4 py-2 rounded-lg font-bold text-sm bg-white text-emerald-800 shadow-sm flex justify-between items-center transition-all hover:bg-emerald-50">
                                <span>{loadedSegments[0]?.book} â€¢ Cap. {loadedSegments[0]?.chapter}</span>
                                <i className="fa-solid fa-chevron-down text-xs opacity-40"></i>
                            </button>
                            <button onClick={() => setView('import')} className="w-10 h-10 rounded-lg bg-white text-emerald-600 shadow flex items-center justify-center font-bold text-xl transition-all hover:bg-emerald-50"><i className="fa-solid fa-plus"></i></button>
                        </div>
                    </header>

                    {/* CONTENIDO PRINCIPAL */}
                    <main className="flex-grow overflow-y-auto no-scrollbar p-4 relative">
                        
                        {view === 'reading' && loadedSegments.map(seg => (
                            <div key={`${seg.book}-${seg.chapter}`} className="animate-fade-in mb-8">
                                <div className="flex justify-between items-center mb-4 border-b border-emerald-500/20 pb-2">
                                    <h2 className="text-2xl font-serif italic text-emerald-600 dark:text-emerald-400">{seg.book} {seg.chapter}</h2>
                                    <div className="flex gap-4 items-center">
                                        <button onClick={() => {
                                            const u = new SpeechSynthesisUtterance(bible.content[seg.book][seg.chapter].join(' '));
                                            u.lang = 'es-ES'; synth.current.speak(u);
                                        }} className="text-slate-300 hover:text-orange-500 transition-all"><i className="fa-solid fa-volume-high text-xl"></i></button>
                                        <button onClick={() => toggleRead(seg.book, seg.chapter)} className={`text-2xl transition-colors ${readStatus[`${seg.book}-${seg.chapter}`] ? 'text-emerald-500' : 'text-slate-300'}`}>
                                            <i className="fa-solid fa-circle-check"></i>
                                        </button>
                                    </div>
                                </div>
                                <div className="space-y-4 pb-12">
                                    {(bible.content[seg.book]?.[seg.chapter] || []).map((txt, i) => {
                                        const vId = `${seg.book}-${seg.chapter}-${i+1}`;
                                        const meta = annotations[vId] || {};
                                        return (
                                            <div key={vId} className={`p-3 rounded-lg transition-all ${meta.color ? `highlight-${meta.color}` : 'hover:bg-slate-50 dark:hover:bg-slate-800'}`}>
                                                <div className="flex gap-3">
                                                    <span className="text-sm font-bold text-indigo-500 mt-1 w-6 shrink-0 text-right">{i+1}</span>
                                                    <div className="flex-grow min-w-0">
                                                        <p style={{ fontSize: fontSize, lineHeight: 1.6, fontFamily: 'serif' }} onClick={() => setActiveV(activeV === vId ? null : vId)} className="cursor-pointer select-none">{txt}</p>
                                                        
                                                        {meta.notes?.length > 0 && (
                                                            <div className="mt-2 space-y-1">
                                                                {meta.notes.map(n => (
                                                                    <div key={n.id} className="text-[11px] bg-amber-50 dark:bg-amber-900/20 p-2 rounded border-l-2 border-amber-400 flex flex-col shadow-sm">
                                                                        {editingNote.nId === n.id ? (
                                                                            <div className="flex flex-col gap-2 w-full p-1">
                                                                                <textarea 
                                                                                    value={editingNote.text} 
                                                                                    onChange={e => setEditingNote({...editingNote, text: e.target.value})}
                                                                                    className="w-full p-2 text-xs rounded border dark:bg-slate-800 dark:border-slate-700 outline-none"
                                                                                />
                                                                                <div className="flex gap-2 justify-end">
                                                                                    <button onClick={() => setEditingNote({vId: null, nId: null, text: ""})} className="text-slate-400 text-[10px] font-bold uppercase p-1">Cancelar</button>
                                                                                    <button onClick={saveEditedNote} className="bg-emerald-500 text-white px-3 py-1 rounded text-[10px] font-bold">Guardar</button>
                                                                                </div>
                                                                            </div>
                                                                        ) : (
                                                                            <div className="flex justify-between items-start">
                                                                                <span className="italic leading-relaxed p-0.5">{n.text}</span>
                                                                                <div className="flex gap-2 ml-2 shrink-0 p-1">
                                                                                    <button onClick={() => setEditingNote({ vId, nId: n.id, text: n.text })} className="text-indigo-400 hover:text-indigo-600"><i className="fa-solid fa-pencil"></i></button>
                                                                                    <button onClick={() => setAnnotations(p => ({ ...p, [vId]: { ...p[vId], notes: p[vId].notes.filter(x=>x.id!==n.id) } }))} className="text-rose-400 hover:text-rose-600"><i className="fa-solid fa-trash-can"></i></button>
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}

                                                        {activeV === vId && (
                                                            <div className="mt-4 pt-3 border-t dark:border-slate-700 animate-slide-up">
                                                                <div className="flex justify-between items-center mb-3 flex-wrap gap-2">
                                                                    <div className="flex gap-2">
                                                                        {['yellow', 'green', 'blue', 'red'].map(c => (
                                                                            <button key={c} onClick={() => {
                                                                                const cur = annotations[vId] || {};
                                                                                setAnnotations(p => ({ ...p, [vId]: { ...cur, color: cur.color === c ? null : c } }));
                                                                            }} className={`w-6 h-6 rounded-full highlight-${c} border border-slate-300 shadow-sm active:scale-90 transition-transform`}></button>
                                                                        ))}
                                                                    </div>
                                                                    <div className="flex gap-3">
                                                                        <button onClick={() => {
                                                                            const ex = favorites.find(f => f.id === vId);
                                                                            if (ex) setFavorites(favorites.filter(f => f.id !== vId));
                                                                            else setFavorites([...favorites, { id: vId, text: txt, ref: `${seg.book} ${seg.chapter}:${i+1}` }]);
                                                                        }} className={favorites.find(f=>f.id===vId) ? 'text-yellow-500' : 'text-slate-300'}><i className="fa-solid fa-star text-xl"></i></button>
                                                                        <button onClick={() => analyzeVerse(txt, `${seg.book} ${seg.chapter}:${i+1}`)} className="bg-emerald-600 text-white px-3 py-1 rounded-full text-[10px] font-bold shadow-md active:scale-95 transition-all"><i className="fa-solid fa-brain mr-1 text-xs"></i> IA</button>
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-col sm:flex-row gap-2 mb-3">
                                                                    <input 
                                                                        value={noteInput} 
                                                                        onChange={e => setNoteInput(e.target.value)} 
                                                                        placeholder="Escribe una nota..." 
                                                                        className={`flex-grow min-w-0 p-2 text-xs rounded border outline-none ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white'}`} 
                                                                    />
                                                                    <button onClick={() => addNote(vId)} className="bg-indigo-500 text-white px-4 py-2 rounded text-xs font-bold active:scale-95 transition-transform shrink-0">Guardar</button>
                                                                </div>
                                                                {aiLoad && <div className="text-[10px] text-emerald-500 animate-pulse font-bold pb-2">Analizando con profundidad...</div>}
                                                                
                                                                {aiResp && (
                                                                    <div className="mt-5 pt-3 border-t-2 border-emerald-500/10 relative group animate-fade-in">
                                                                        <div className="absolute -top-3 right-0 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                           <button onClick={() => setAiResp("")} title="Cerrar" className="text-slate-300 hover:text-emerald-500 p-1 bg-white dark:bg-slate-900 rounded-full border border-slate-200 dark:border-slate-700"><i className="fa-solid fa-xmark text-lg"></i></button>
                                                                        </div>
                                                                        <div className="text-left w-full">
                                                                            {renderMD(aiResp)}
                                                                        </div>
                                                                        <button onClick={() => setAiResp("")} className="mt-8 text-[11px] font-bold text-slate-400 uppercase tracking-[4px] hover:text-emerald-500 transition-colors block text-center w-full pb-6">Finalizar AnÃ¡lisis</button>
                                                                    </div>
                                                                )}
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}

                        {view === 'navigation' && (
                            <div className="animate-slide-up">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-emerald-600">Navegar</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                <div className="flex gap-2 mb-6">
                                    <button onClick={() => setNavStep('books')} className={`flex-1 p-3 rounded-xl font-bold text-sm ${navStep==='books'?'bg-emerald-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>Libros</button>
                                    <button disabled={!navBook} onClick={() => setNavStep('chapters')} className={`flex-1 p-3 rounded-xl font-bold text-sm ${navStep==='chapters'?'bg-emerald-600 text-white':'bg-slate-100 dark:bg-slate-800'}`}>CapÃ­tulos</button>
                                </div>
                                <div className="grid grid-cols-2 gap-3 pb-10">
                                    {navStep === 'books' ? bible.books.map(b => (
                                        <button key={b} onClick={() => { setNavBook(b); setNavStep('chapters'); }} className="p-4 rounded-xl border dark:border-slate-700 font-bold text-left dark:bg-slate-800 hover:border-emerald-500 transition-colors">
                                            <i className="fa-solid fa-book mr-2 opacity-30 text-emerald-500"></i> {b}
                                        </button>
                                    )) : Object.keys(bible.content[navBook] || {}).map(c => (
                                        <button key={c} onClick={() => { setLoadedSegments([{book:navBook, chapter:parseInt(c)}]); setView('reading'); }} className="p-4 rounded-xl border dark:border-slate-700 font-bold text-center dark:bg-slate-800 hover:bg-emerald-600 hover:text-white transition-all">
                                            {c}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'assistant' && (
                            <div className="flex flex-col h-full animate-fade-in space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-emerald-600">Asistente BÃ­blico</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                
                                {/* SELECTOR DE ENFOQUE */}
                                <div className="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl shadow-inner">
                                    {[
                                        { id: 'teologo', label: 'TeÃ³logo', icon: 'fa-scroll' },
                                        { id: 'historiador', label: 'Historiador', icon: 'fa-landmark' },
                                        { id: 'pastor', label: 'Pastor', icon: 'fa-hands-praying' }
                                    ].map(role => (
                                        <button 
                                            key={role.id}
                                            onClick={() => { setAssistantPersona(role.id); setAssistantResponse(""); }}
                                            className={`flex-1 py-2.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 ${assistantPersona === role.id ? 'bg-white dark:bg-slate-700 text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}
                                        >
                                            <i className={`fa-solid ${role.icon}`}></i>
                                            {role.label}
                                        </button>
                                    ))}
                                </div>

                                <div className="space-y-4">
                                    <div className="relative">
                                        <textarea 
                                            value={assistantQuery}
                                            onChange={e => setAssistantQuery(e.target.value)}
                                            onKeyDown={e => e.key==='Enter' && !e.shiftKey && (e.preventDefault(), handleAssistantInquiry())}
                                            placeholder={`Pregunta al ${assistantPersona}...`}
                                            className={`w-full p-4 pr-12 rounded-2xl outline-none border transition-all min-h-[120px] shadow-sm ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 focus:border-emerald-500'}`}
                                        />
                                        <button 
                                            onClick={handleAssistantInquiry}
                                            className="absolute bottom-4 right-4 w-10 h-10 bg-emerald-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform"
                                        >
                                            <i className={aiLoad ? "fa-solid fa-circle-notch fa-spin" : "fa-solid fa-magnifying-glass"}></i>
                                        </button>
                                    </div>
                                </div>

                                {/* ESPACIO DE RESPUESTA INTEGRADO */}
                                {assistantResponse && (
                                    <div className="animate-fade-in border-t border-slate-200 dark:border-slate-800 pt-6 pb-20">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className="w-10 h-10 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center text-emerald-600">
                                                <i className={`fa-solid ${assistantPersona === 'teologo' ? 'fa-scroll' : assistantPersona === 'historiador' ? 'fa-landmark' : 'fa-hands-praying'} text-xl`}></i>
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-sm uppercase tracking-widest text-emerald-600">Estudio del {assistantPersona}</h3>
                                                <p className="text-[10px] opacity-40 uppercase font-bold">Enfoque personalizado</p>
                                            </div>
                                        </div>
                                        <div className="text-left w-full">
                                            {renderMD(assistantResponse)}
                                        </div>
                                    </div>
                                )}
                                
                                {!assistantResponse && !aiLoad && (
                                    <div className="text-center py-20 opacity-20 italic">
                                        <i className="fa-solid fa-bible text-6xl mb-4"></i>
                                        <p className="text-sm px-6">Elige un rol superior, escribe tu consulta y presiona buscar para generar un estudio especÃ­fico.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'favorites' && (
                            <div className="animate-slide-up space-y-4">
                                <div className="flex justify-between items-center mb-2">
                                    <h2 className="text-xl font-bold text-emerald-600">Favoritos</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                {favorites.length === 0 && <p className="text-center py-20 opacity-40 italic">AÃºn no tienes versÃ­culos favoritos.</p>}
                                {favorites.map(f => (
                                    <div key={f.id} className="p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm group">
                                        <div className="flex justify-between items-center mb-2">
                                            <span onClick={() => {
                                                const parts = f.id.split('-');
                                                setLoadedSegments([{book:parts[0], chapter:parseInt(parts[1])}]); setView('reading');
                                            }} className="text-xs font-bold text-emerald-600 underline cursor-pointer">{f.ref}</span>
                                            <button onClick={() => setFavorites(favorites.filter(x=>x.id!==f.id))} className="text-rose-400 opacity-0 group-hover:opacity-100 transition-opacity"><i className="fa-solid fa-trash-can"></i></button>
                                        </div>
                                        <p className="text-sm italic opacity-80 leading-relaxed">"{f.text}"</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'search' && (
                            <div className="animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-emerald-600">Buscador</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                <div className="flex gap-2 mb-6">
                                    <input value={searchQ} onChange={e => setSearchQ(e.target.value)} onKeyDown={e => e.key==='Enter' && runSearch()} placeholder="Palabra clave..." className={`flex-grow p-4 rounded-xl outline-none shadow-inner ${darkMode ? 'bg-slate-800 border-slate-700 border text-white' : 'bg-slate-100'}`} />
                                    <button onClick={runSearch} className="bg-emerald-600 text-white px-6 rounded-xl shadow-md"><i className="fa-solid fa-magnifying-glass"></i></button>
                                </div>
                                <div className="space-y-3 pb-10">
                                    {searchRes.map((r, i) => (
                                        <div key={i} onClick={() => { setLoadedSegments([{book:r.b, chapter:r.c}]); setView('reading'); }} className="p-4 rounded-xl border dark:border-slate-700 bg-white dark:bg-slate-800 cursor-pointer hover:border-emerald-500 transition-colors">
                                            <span className="text-xs font-bold text-emerald-600">{r.b} {r.c}:{r.v}</span>
                                            <p className="text-sm italic mt-1 opacity-70 leading-relaxed">"{r.t}"</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-emerald-600">Ajustes</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                <div className="p-6 rounded-2xl border dark:bg-slate-800 dark:border-slate-700 bg-white shadow-sm text-center">
                                    <label className="text-xs font-bold opacity-50 block mb-4 uppercase tracking-widest">TamaÃ±o de Fuente: {fontSize}px</label>
                                    <input type="range" min="14" max="32" value={fontSize} onChange={e => setFontSize(parseInt(e.target.value))} className="w-full mb-8" />
                                    <button onClick={async () => {
                                        setIsLoading(true);
                                        const res = await fetch('https://raw.githubusercontent.com/thiagobodruk/bible/master/json/es_rvr09.json');
                                        const data = await res.json();
                                        const bks = []; const cont = {};
                                        data.forEach(b => { bks.push(b.name); cont[b.name] = {}; b.chapters.forEach((v, i) => cont[b.name][i+1] = v); });
                                        setBible({ books: bks, content: cont }); setView('reading');
                                    }} className="w-full p-4 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/20 active:scale-95 transition-transform">Descargar Reina Valera 1909</button>
                                </div>
                            </div>
                        )}

                        {view === 'plans' && (
                            <div className="animate-fade-in space-y-6">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-emerald-600">Devocionales</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                <div className="space-y-4 pb-10">
                                    {PREDEFINED_PLANS.map(p => {
                                        const prog = calculateProgress(p);
                                        return (
                                            <div key={p.id} className="p-5 rounded-2xl border dark:border-slate-700 border-l-4 border-l-emerald-500 bg-white dark:bg-slate-800 shadow-sm relative overflow-hidden">
                                                <div className="flex justify-between items-start mb-2">
                                                    <div>
                                                        <h3 className="font-bold text-sm">{p.title}</h3>
                                                        <p className="text-[10px] opacity-60 italic">{p.desc}</p>
                                                    </div>
                                                    <span className="text-xs font-bold text-emerald-600 bg-emerald-100 dark:bg-emerald-900/40 px-2 py-1 rounded">{prog}%</span>
                                                </div>
                                                <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full mb-4 overflow-hidden">
                                                    <div style={{ width: `${prog}%` }} className="h-full bg-emerald-500 transition-all duration-700"></div>
                                                </div>
                                                <div className="space-y-2">
                                                    {p.days.map((d, i) => {
                                                        const isRead = readStatus[`${d.b}-${d.c}`];
                                                        return (
                                                            <button 
                                                                key={i} 
                                                                onClick={() => { setLoadedSegments([{book:d.b, chapter:d.c}]); setView('reading'); }} 
                                                                className={`w-full text-left p-3 rounded-xl text-[11px] font-bold flex justify-between items-center transition-all ${isRead ? 'bg-emerald-50 dark:bg-emerald-950/30 text-emerald-600 border border-emerald-200 dark:border-emerald-800' : 'bg-slate-50 dark:bg-slate-700 hover:bg-slate-100'}`}
                                                            >
                                                                <span>DÃ­a {i+1}: {d.b} {d.c}</span>
                                                                {isRead ? <i className="fa-solid fa-check-circle"></i> : <i className="fa-regular fa-circle opacity-30"></i>}
                                                            </button>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'import' && (
                            <div className="animate-fade-in space-y-4">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-xl font-bold text-emerald-600">Importar Texto</h2>
                                    <button onClick={() => setView('reading')} className="text-slate-400 hover:text-emerald-500 transition-colors"><i className="fa-solid fa-circle-xmark text-2xl"></i></button>
                                </div>
                                <p className="text-xs opacity-50 italic leading-relaxed">Pega un capÃ­tulo completo aquÃ­ para guardarlo en tu biblioteca personal.</p>
                                <textarea className={`w-full h-64 p-4 rounded-xl border outline-none shadow-inner ${darkMode ? 'bg-slate-800 dark:border-slate-700 text-white' : 'bg-slate-100'}`} placeholder="Pega el contenido aquÃ­..."></textarea>
                                <button className="w-full p-4 bg-emerald-600 text-white rounded-xl font-bold shadow-md">Guardar en Biblioteca</button>
                            </div>
                        )}

                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

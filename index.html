<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Biblia</title>
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Biblia">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3389/3389081.png">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        slate: { 950: '#020617' },
                        emerald: { 600: '#10b981', 700: '#059669' }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.2s ease-out forwards', 
                        'slide-up': 'slideUp 0.2s ease-out forwards' 
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(8px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-top { padding-top: var(--sat); }
        .safe-bottom { padding-bottom: var(--sab); }
        .highlight-yellow { background-color: #fef9c3; border-left: 5px solid #facc15; } 
        .highlight-green { background-color: #dcfce7; border-left: 5px solid #4ade80; }
        .highlight-blue { background-color: #dbeafe; border-left: 5px solid #60a5fa; }
        .highlight-red { background-color: #fee2e2; border-left: 5px solid #f87171; }
        .dark .highlight-yellow { background-color: rgba(66, 32, 6, 0.9); border-left-color: #eab308; }
        .dark .highlight-green { background-color: rgba(5, 46, 22, 0.9); border-left-color: #22c55e; }
        .dark .highlight-blue { background-color: rgba(23, 37, 84, 0.9); border-left-color: #3b82f6; }
        .dark .highlight-red { background-color: rgba(69, 10, 10, 0.9); border-left-color: #ef4444; }
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 22px; width: 22px; border-radius: 50%; background: #10b981; border: 3px solid white; margin-top: -8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; }
    </style>
</head>
<body class="bg-white text-slate-900 h-[100dvh] overflow-hidden transition-colors duration-300">
    <div id="root" class="h-full flex justify-center w-full"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- MOTOR DE SABIDURÍA LOCAL (SISTEMA AUTÓNOMO) ---
        const MatrixWisdomEngine = {
            doctrines: [
                {
                    id: "cristologia",
                    keys: ["jesus", "cristo", "señor", "hijo", "mesias", "nazaret", "cordero", "maestro", "verbo"],
                    teologo: "Este pasaje se centra en la naturaleza redentora de Jesucristo. Se resalta Su deidad y Su papel como el mediador perfecto entre la santidad de Dios y la humanidad, cumpliendo las promesas del antiguo pacto mediante Su encarnación y sacrificio final.",
                    historiador: "En el contexto del siglo I, proclamar a Jesús como Señor desafiaba el culto imperial romano. Este mensaje se extendió rápidamente gracias a la red de caminos y la estabilidad relativa del imperio, desafiando las estructuras religiosas de la época.",
                    pastor: "Jesús te entiende profundamente porque Él se hizo hombre y habitó entre nosotros. No importa cuál sea tu lucha hoy, Su compasión es infinita y Su poder está disponible para restaurar tu vida. Confía en Su guía; Él es el buen pastor que nunca abandona a Sus ovejas."
                },
                {
                    id: "soteriologia",
                    keys: ["salvacion", "gracia", "perdon", "cruz", "sangre", "redencion", "justicia", "regalo", "inmerecido", "paz"],
                    teologo: "La doctrina de la justificación por la gracia mediante la fe es el núcleo aquí. El texto explica cómo el hombre es reconciliado con el Creador no por sus obras, sino por el favor soberano de Dios que otorga justicia al creyente a través del mérito de Cristo.",
                    historiador: "El concepto de gracia rompió con la moralidad de la época que se basaba en el cumplimiento de rituales externos y sacrificios animales. El cristianismo introdujo una ética interna basada en el agradecimiento por una deuda que el ser humano no podía pagar por sí mismo.",
                    pastor: "Deja de intentar ganar un amor que Dios ya te ha regalado. La gracia significa que no tienes que ser perfecto para acercarte a Su trono. Recibe hoy Su perdón, suelta las cargas de tu pasado y permítete vivir bajo la libertad de saber que eres profundamente amado por tu Padre."
                },
                {
                    id: "consuelo",
                    keys: ["paz", "llanto", "tristeza", "dolor", "consuelo", "lagrimas", "esperanza", "descanso", "angustia", "prueba"],
                    teologo: "Se subraya el atributo de Dios como el Consolador Supremo. Este pasaje enseña que el sufrimiento humano no es el final de la historia, sino un proceso de refinamiento donde la fidelidad de Dios brilla con más fuerza, asegurando un propósito eterno en medio de la aflicción.",
                    historiador: "Esta literatura de esperanza era el sostén de las comunidades en tiempos de persecución bajo emperadores romanos. Servía para reafirmar la identidad del creyente como ciudadano de un reino eterno que no puede ser conmovido por las tragedias temporales.",
                    pastor: "Dios está cerca de los quebrantados de corazón. Aunque hoy camines por un valle de sombras, no estás solo; Su vara y Su cayado te infunden aliento. Permite que Su paz guarde tu mente y recuerda que después de cada noche oscura, Su misericordia siempre trae un nuevo amanecer."
                }
            ],
            genres: {
                ley: {
                    teologo: "Establece el estándar moral y ritual que refleja la santidad divina, sirviendo como un ayo que nos muestra nuestra necesidad de un Redentor.",
                    historiador: "Documenta el nacimiento jurídico de Israel como nación teocrática tras el Éxodo, diferenciándose radicalmente de los códigos legales paganos de la época.",
                    pastor: "Los mandatos de Dios son vallados de protección para tu vida. Sigue Sus sendas de justicia y encontrarás el bienestar que Él ha diseñado para ti y tu familia."
                },
                poesia: {
                    teologo: "Expresa la relación íntima y honesta entre el ser humano y Dios, integrando la adoración, la duda y el agradecimiento en una sola fe viva.",
                    historiador: "Estos poemas y cánticos formaban la liturgia del Templo y los hogares, transmitiendo la fe de generación en generación mediante la belleza del lenguaje.",
                    pastor: "Usa estas palabras para hablar con Dios hoy. Él valora tu honestidad y desea que derrames tu corazón ante Él. No hay oración pequeña para un Dios tan grande."
                }
            },
            generic: {
                teologo: "Este texto nos invita a contemplar la soberanía de Dios y Su revelación progresiva a lo largo de la historia. Cada palabra inspirada tiene el propósito de formarnos y darnos sabiduría en el camino de la santidad.",
                historiador: "El trasfondo de este mensaje revela la fidelidad de Dios hacia Su pueblo en medio de desafíos culturales y políticos, recordándonos que Su Palabra permanece firme a pesar del paso de los siglos.",
                pastor: "Recibe esta reflexión como una palabra fresca para tu alma hoy. Dios tiene un plan específico para ti y desea guiarte en cada decisión. Confía en Su proceso y camina con fe, sabiendo que Él es fiel."
            }
        };

        const generateEnhancedLocalFallback = (text, role, bookName) => {
            const lowText = text.toLowerCase();
            const lowBook = (bookName || "").toLowerCase();
            let scores = {};
            MatrixWisdomEngine.doctrines.forEach(doc => {
                scores[doc.id] = 0;
                doc.keys.forEach(key => { if (lowText.includes(key)) scores[doc.id] += 2; });
            });
            let bestId = null; let maxScore = 0;
            for (let id in scores) { if (scores[id] > maxScore) { maxScore = scores[id]; bestId = id; } }
            if (bestId && maxScore > 0) return MatrixWisdomEngine.doctrines.find(d => d.id === bestId)[role];
            if (["génesis", "éxodo", "levítico", "números", "deuteronomio"].includes(lowBook)) return MatrixWisdomEngine.genres.ley[role];
            if (["salmos", "proverbios", "job", "cantares", "eclesiastés"].includes(lowBook)) return MatrixWisdomEngine.genres.poesia[role];
            return MatrixWisdomEngine.generic[role];
        };

        // --- MOTOR DE CONSULTA GEMINI 1.5 FLASH ---
        async function fetchGemini(key, prompt, isVerse = false, retries = 3) {
            if (!key) return null;
            const system = `Eres un experto bíblico profundo. Responde siempre en ESPAÑOL. NO USES negritas (**).
            ${isVerse ? 
                'Analiza detalladamente en 3 partes: TEÓLOGO, HISTORIADOR y PASTOR. Cada sección de 3 frases sólidas y extensas.' : 
                'Responde con profundidad teológica en 4 párrafos cortos sin rodeos.'}`;
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            systemInstruction: { parts: [{ text: system }] }
                        })
                    });
                    const data = await resp.json();
                    if (data.error) throw new Error(data.error.message);
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
                } catch (e) {
                    if (i === retries - 1) return null;
                    await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                }
            }
            return null;
        }

        // --- PERSISTENCIA (IDB) ---
        const DB_NAME = 'Bible_App_V16';
        const db = {
            init: () => new Promise(res => {
                const req = indexedDB.open(DB_NAME, 1);
                req.onupgradeneeded = e => {
                    const d = e.target.result;
                    if (!d.objectStoreNames.contains('appData')) d.createObjectStore('appData');
                    if (!d.objectStoreNames.contains('bibleStore')) d.createObjectStore('bibleStore');
                };
                req.onsuccess = e => res(e.target.result);
                req.onerror = () => res(null);
            }),
            get: (store, key) => new Promise(async res => {
                const inst = await db.init(); if(!inst) return res(null);
                const req = inst.transaction(store, 'readonly').objectStore(store).get(key);
                req.onsuccess = () => res(req.result);
            }),
            set: (store, key, val) => new Promise(async res => {
                const inst = await db.init(); if(!inst) return res(null);
                inst.transaction(store, 'readwrite').objectStore(store).put(val, key).oncomplete = () => res();
            })
        };

        const CORE_BOOKS = ['Génesis', 'Salmos', 'Juan', 'Romanos'];
        const CORE_DATA = {
            'Génesis': { 1: ["En el principio creó Dios los cielos y la tierra.", "Y la tierra estaba desordenada y vacía...", "Y dijo Dios: Sea la luz; y fue la luz."] },
            'Salmos': { 1: ["Bienaventurado el varón que no anduvo en consejo de malos.", "Sino que en la ley de Jehová está su delicia."], 23: ["Jehová es mi pastor; nada me faltará.", "En lugares de delicados pastos me hará descansar.", "Confortará mi alma..."] },
            'Juan': { 1: ["En el principio era el Verbo, y el Verbo era con Dios, y el Verbo era Dios."], 3: ["Había un hombre de los fariseos que se llamaba Nicodemo.", "Respondió Jesús: De cierto te digo, que el que no naciere de nuevo, no puede ver el reino de Dios."] },
            'Romanos': { 8: ["Ahora, pues, ninguna condensación hay para los que están en Cristo Jesús."] }
        };

        const INITIAL_PLANS = [
            { id: 'p1', title: 'Fundamentos de la Fe', days: [{b:'Juan', c:1}, {b:'Juan', c:3}, {b:'Romanos', c:8}] },
            { id: 'p2', title: 'Paz en la Tormenta', days: [{b:'Salmos', c:23}, {b:'Salmos', c:1}] }
        ];

        function App() {
            const [view, setView] = useState('reading');
            const [bible, setBible] = useState({ books: CORE_BOOKS, content: CORE_DATA });
            const [annotations, setAnnotations] = useState({});
            const [favorites, setFavorites] = useState([]);
            const [readStatus, setReadStatus] = useState({});
            const [planProgress, setPlanProgress] = useState({});
            const [streak, setStreak] = useState({ count: 0, lastDate: null });
            const [fontSize, setFontSize] = useState(20);
            const [darkMode, setDarkMode] = useState(false);
            const [currentChapter, setCurrentChapter] = useState({book: 'Juan', chapter: 3});
            const [ready, setReady] = useState(false);
            const [activeV, setActiveV] = useState(null);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiVersePanel, setAiVersePanel] = useState(null);
            const [asstQuery, setAsstQuery] = useState("");
            const [asstRole, setAsstRole] = useState("teologo");
            const [asstResponse, setAsstResponse] = useState("");
            const [searchQ, setSearchQ] = useState("");
            const [searchRes, setSearchRes] = useState([]);
            const [noteInput, setNoteInput] = useState("");
            const [userApiKey, setUserApiKey] = useState("");

            useEffect(() => {
                const load = async () => {
                    const saved = await db.get('appData', 'config_v900');
                    const full = await db.get('bibleStore', 'bible_v900');
                    if (saved) {
                        setAnnotations(saved.annotations || {});
                        setFavorites(saved.favorites || []);
                        setReadStatus(saved.readStatus || {});
                        setPlanProgress(saved.planProgress || {});
                        setStreak(saved.streak || { count: 0, lastDate: null });
                        setFontSize(saved.fontSize || 20);
                        setDarkMode(saved.darkMode || false);
                        setUserApiKey(saved.userApiKey || "");
                    }
                    if (full) setBible(full);
                    setReady(true);
                };
                load();
            }, []);

            useEffect(() => {
                if (ready) {
                    db.set('appData', 'config_v900', { annotations, favorites, readStatus, fontSize, darkMode, planProgress, streak, userApiKey });
                    document.body.classList.toggle('dark', darkMode);
                }
            }, [ready, annotations, favorites, readStatus, fontSize, darkMode, planProgress, streak, userApiKey]);

            const updateStreak = () => {
                const today = new Date().toISOString().split('T')[0];
                if (streak.lastDate === today) return;
                setStreak(prev => ({ count: prev.count + 1, lastDate: today }));
            };

            const downloadFullBible = async () => {
                try {
                    const URL = 'https://raw.githubusercontent.com/thiagobodruk/bible/master/json/es_rvr09.json';
                    const response = await fetch(URL);
                    const data = await response.json();
                    const bks = []; const cont = {};
                    data.forEach(b => { bks.push(b.name); cont[b.name] = {}; b.chapters.forEach((vArray, idx) => { cont[b.name][idx + 1] = vArray; }); });
                    const finalData = { books: bks, content: cont };
                    await db.set('bibleStore', 'bible_v900', finalData);
                    setBible(finalData);
                } catch (error) { console.error(error); }
            };

            const handleToggleVerse = (vId) => {
                updateStreak();
                if (activeV !== vId) { setAiVersePanel(null); setActiveV(vId); }
                else { setActiveV(null); setAiVersePanel(null); }
            };

            const toggleFav = (vId, text, ref, b, c) => {
                const already = favorites.some(f => f.id === vId);
                if (already) setFavorites(prev => prev.filter(f => f.id !== vId));
                else setFavorites(prev => [...prev, { id: vId, text, ref, b, c }]);
            };

            const handleSearch = () => {
                const q = searchQ.toLowerCase().trim();
                if (!q) { setSearchRes([]); return; }
                const results = [];
                bible.books.forEach(b => {
                    const bData = bible.content[b];
                    if (bData) {
                        Object.keys(bData).forEach(c => {
                            bData[c].forEach((t, i) => { if (t.toLowerCase().includes(q)) results.push({ b, c, v: i+1, t }); });
                        });
                    }
                });
                setSearchRes(results);
            };

            const handleSynthesis = async (txt) => {
                setAiLoading(true); setAiVersePanel(null);
                const aiResult = await fetchGemini(userApiKey, `Analiza detalladamente este versículo: "${txt}"`, true);
                if (aiResult) {
                    const parts = aiResult.split(/(TEÓLOGO|HISTORIADOR|PASTOR):/i);
                    setAiVersePanel({
                        teologo: (parts[2] || aiResult).trim(),
                        historiador: (parts[4] || "Contexto clave analizado con éxito.").trim(),
                        pastor: (parts[6] || "Aplicación directa para tu vida hoy.").trim()
                    });
                } else {
                    setAiVersePanel({
                        teologo: generateEnhancedLocalFallback(txt, "teologo", currentChapter.book),
                        historiador: generateEnhancedLocalFallback(txt, "historiador", currentChapter.book),
                        pastor: generateEnhancedLocalFallback(txt, "pastor", currentChapter.book)
                    });
                }
                setAiLoading(false);
            };

            const handleAssistantAsk = async () => {
                if (!asstQuery.trim() || aiLoading) return;
                setAiLoading(true); setAsstResponse("");
                const aiResult = await fetchGemini(userApiKey, `Responde con sabiduría como ${asstRole}: ${asstQuery}`);
                if (aiResult) {
                    setAsstResponse(aiResult);
                } else {
                    setAsstResponse(generateEnhancedLocalFallback(asstQuery, asstRole, currentChapter.book));
                }
                setAiLoading(false); updateStreak();
            };

            const togglePlanDay = (planId, dayIdx) => {
                const current = planProgress[planId] || [];
                const updated = current.includes(dayIdx) ? current.filter(d => d !== dayIdx) : [...current, dayIdx];
                setPlanProgress({ ...planProgress, [planId]: updated });
                updateStreak();
            };

            const ExpertItem = ({ icon, title, text, color }) => (
                <div className={`mb-4 border-l-[5px] pl-4 pr-3 py-3 border-${color}-500 bg-${color}-50/40 dark:bg-${color}-950/20 rounded-r-2xl animate-fade-in shadow-sm w-full`}>
                    <div className="flex items-center gap-2 mb-2">
                        <i className={`fa-solid ${icon} text-[14px] text-${color}-600`}></i>
                        <span className="font-black text-[11px] uppercase tracking-widest text-${color}-800 opacity-60">{title}</span>
                    </div>
                    <div className="text-[17px] leading-relaxed text-justify font-medium opacity-95 break-words whitespace-pre-wrap">{text}</div>
                </div>
            );

            if (!ready) return null;

            return (
                <div className={`flex flex-col h-full w-full md:max-w-3xl shadow-2xl overflow-hidden transition-all relative mx-auto ${darkMode ? 'bg-slate-900 text-slate-100' : 'bg-white text-slate-800'}`}>
                    <header className={`safe-top ${darkMode ? 'bg-emerald-950' : 'bg-emerald-600'} text-white shadow-lg z-30 shrink-0 w-full`}>
                        <div className="flex justify-between items-center px-4 py-2">
                            <div className="flex items-center gap-2">
                                <h1 className="font-black text-[12px] tracking-widest opacity-90 uppercase">Biblia</h1>
                                <div className="flex items-center gap-1.5 px-2.5 py-0.5 bg-white/10 rounded-full border border-white/10">
                                    <i className="fa-solid fa-fire text-orange-400 text-[10px]"></i>
                                    <span className="font-black text-[11px]">{streak.count}</span>
                                </div>
                            </div>
                            <div className="flex gap-0.5">
                                {[{v:'search',i:'fa-magnifying-glass'},{v:'assistant',i:'fa-robot'},{v:'plans',i:'fa-calendar-check'},{v:'favorites',i:'fa-star'},{v:'settings',i:'fa-gear'}].map(b => (
                                    <button key={b.v} onClick={() => setView(b.v)} className={`w-8 h-8 flex items-center justify-center rounded-full transition-all ${view===b.v?'bg-white/20 shadow-inner':''}`}><i className={`fa-solid ${b.i} text-[15px]`}></i></button>
                                ))}
                                <button onClick={() => setDarkMode(!darkMode)} className="w-8 h-8 flex items-center justify-center rounded-full transition-all ml-1"><i className={`fa-solid ${darkMode?'fa-sun':'fa-moon'} text-[15px]`}></i></button>
                            </div>
                        </div>
                        <div className="px-3 pb-2.5">
                            <button onClick={() => setView('nav')} className="w-full text-left px-4 py-2 rounded-xl font-bold text-[16px] bg-white text-emerald-900 shadow-md flex justify-between items-center active:scale-[0.98] transition-all border border-emerald-500/10">
                                <span className="flex items-center gap-2"><i className="fa-solid fa-book-open text-[14px] opacity-30"></i>{currentChapter.book} <span className="opacity-40 ml-0.5">Cap. {currentChapter.chapter}</span></span>
                                <i className="fa-solid fa-chevron-down text-[10px] opacity-20"></i>
                            </button>
                        </div>
                    </header>

                    <main className="flex-grow overflow-y-auto no-scrollbar p-0 safe-bottom relative w-full">
                        {view === 'reading' && (
                            <div className="animate-fade-in w-full pb-24">
                                <div className="flex justify-between items-center mt-5 mb-3 border-b border-emerald-500/5 pb-2.5 px-4">
                                    <h2 className="text-2xl font-serif italic text-emerald-600 dark:text-emerald-400">{currentChapter.book} {currentChapter.chapter}</h2>
                                    <button onClick={() => { setReadStatus(p => ({ ...p, [`${currentChapter.book}-${currentChapter.chapter}`]: !p[`${currentChapter.book}-${currentChapter.chapter}`] })); updateStreak(); }} className={`text-2xl ${readStatus[`${currentChapter.book}-${currentChapter.chapter}`] ? 'text-emerald-500' : 'text-slate-200'}`}><i className="fa-solid fa-circle-check"></i></button>
                                </div>
                                <div className="space-y-0 w-full">
                                    {(bible.content[currentChapter.book]?.[currentChapter.chapter] || []).map((txt, i) => {
                                        const vId = `${currentChapter.book}-${currentChapter.chapter}-${i+1}`;
                                        const meta = annotations[vId] || {};
                                        const isFav = favorites.some(f => f.id === vId);
                                        return (
                                            <div key={vId} className={`px-4 py-3 transition-all w-full ${meta.color ? `highlight-${meta.color}` : 'hover:bg-slate-50/40 dark:hover:bg-slate-800/10'}`}>
                                                <div className="w-full">
                                                    <p style={{ fontSize: fontSize, lineHeight: 1.55 }} onClick={() => handleToggleVerse(vId)} className="cursor-pointer select-none font-medium text-justify opacity-95 tracking-tight">
                                                        <span className="text-[12px] font-black text-emerald-500/40 mr-2.5 inline-block w-5 select-none text-left italic">{i+1}</span>{txt}
                                                    </p>
                                                    {activeV === vId && (
                                                        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800 animate-slide-up relative">
                                                            <div className="flex justify-between items-center mb-4 gap-2">
                                                                <div className="flex gap-1.5">
                                                                    {['yellow', 'green', 'blue', 'red'].map(c => (
                                                                        <button key={c} onClick={() => setAnnotations({...annotations, [vId]: {...meta, color: meta.color === c ? null : c}})} className={`w-8 h-8 rounded-full highlight-${c} border-2 border-white shadow-md active:scale-90`}></button>
                                                                    ))}
                                                                </div>
                                                                <div className="flex gap-3 items-center">
                                                                    <button onClick={() => toggleFav(vId, txt, `${currentChapter.book} ${currentChapter.chapter}:${i+1}`, currentChapter.book, currentChapter.chapter)} className={isFav ? 'text-yellow-500' : 'text-slate-300'}>
                                                                        <i className="fa-solid fa-star text-2xl"></i>
                                                                    </button>
                                                                    <button onClick={() => handleSynthesis(txt)} className="bg-emerald-600 text-white px-4 py-2 rounded-2xl text-[13px] font-black shadow-lg active:scale-95 flex items-center gap-2">
                                                                        <i className={aiLoading ? "fa-solid fa-sync fa-spin" : "fa-solid fa-bolt"}></i> ESTUDIO PROFUNDO
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            {aiLoading && <div className="p-4 text-center text-emerald-500 animate-pulse font-black text-[10px] uppercase">Buscando sabiduría...</div>}
                                                            {aiVersePanel && (
                                                                <div className="mt-4 bg-white dark:bg-slate-800 p-5 rounded-[2rem] border dark:border-slate-700 shadow-xl">
                                                                    <ExpertItem icon="fa-scroll" title="Teólogo" text={aiVersePanel.teologo} color="blue" />
                                                                    <ExpertItem icon="fa-landmark" title="Historiador" text={aiVersePanel.historiador} color="amber" />
                                                                    <ExpertItem icon="fa-hands-praying" title="Pastor" text={aiVersePanel.pastor} color="emerald" />
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'assistant' && (
                            <div className="animate-fade-in px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Asistente IA</h2>
                                <div className="space-y-6">
                                    <div className="flex bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl w-full">
                                        {['teologo','historiador','pastor'].map(r => (
                                            <button key={r} onClick={() => { setAsstRole(r); setAsstResponse(""); }} className={`flex-1 py-3 rounded-xl font-bold text-[10px] uppercase tracking-widest transition-all ${asstRole === r ? 'bg-white dark:bg-slate-700 text-emerald-600 shadow-md' : 'text-slate-400'}`}>{r}</button>
                                        ))}
                                    </div>
                                    <div className="relative">
                                        <textarea value={asstQuery} onChange={e => setAsstQuery(e.target.value)} placeholder={`Pregunta cualquier cosa...`} className="w-full p-6 rounded-[2rem] outline-none border-2 dark:bg-slate-800 dark:border-slate-700 min-h-[120px] text-[18px] shadow-sm resize-none" />
                                        <button onClick={handleAssistantAsk} className="absolute bottom-5 right-5 w-14 h-14 bg-emerald-600 text-white rounded-[1.2rem] flex items-center justify-center shadow-2xl active:scale-90"><i className={aiLoading ? "fa-solid fa-circle-notch fa-spin text-xl" : "fa-solid fa-paper-plane text-xl"}></i></button>
                                    </div>
                                    {asstResponse && <div className="p-8 bg-white dark:bg-slate-800 rounded-[2.5rem] shadow-2xl border animate-fade-in text-[18px] leading-relaxed whitespace-pre-wrap">{asstResponse}</div>}
                                </div>
                            </div>
                        )}

                        {view === 'favorites' && (
                            <div className="animate-fade-in px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Favoritos</h2>
                                {favorites.length === 0 ? <div className="text-center py-20 opacity-30">Lista vacía</div> : 
                                    favorites.map(f => (
                                        <div key={f.id} className="p-5 rounded-[1.5rem] border dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm mb-4">
                                            <div className="flex justify-between items-start mb-2">
                                                <span onClick={() => { setCurrentChapter({book: f.b, chapter: f.c}); setView('reading'); }} className="text-[11px] font-black text-emerald-600 cursor-pointer italic hover:underline">{f.ref}</span>
                                                <button onClick={() => toggleFav(f.id, f.text, f.ref, f.b, f.c)} className="text-rose-400 opacity-60"><i className="fa-solid fa-trash-can"></i></button>
                                            </div>
                                            <p className="text-[18px] opacity-80 mt-2">"{f.text}"</p>
                                        </div>
                                    ))
                                }
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="animate-fade-in px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Ajustes</h2>
                                <div className="space-y-6">
                                    <div className="p-8 rounded-[2.5rem] border-2 dark:bg-slate-800 bg-white shadow-lg text-center">
                                        <div className="flex justify-between mb-6 items-center"><span className="text-[11px] font-black uppercase opacity-40">Tamaño de Fuente</span><span className="text-emerald-600 font-black text-2xl">{fontSize}px</span></div>
                                        <input type="range" min="14" max="44" value={fontSize} onChange={e => setFontSize(parseInt(e.target.value))} className="w-full" />
                                    </div>

                                    <div className="p-8 rounded-[2.5rem] border-2 border-emerald-100 dark:border-emerald-900/30 bg-emerald-50/30 dark:bg-slate-800 shadow-lg">
                                        <div className="flex items-center gap-2 mb-4">
                                            <i className="fa-solid fa-robot text-emerald-600"></i>
                                            <span className="text-[11px] font-black uppercase tracking-widest text-emerald-700">Configuración de IA (Gemini)</span>
                                        </div>
                                        <p className="text-[12px] opacity-60 mb-4 leading-relaxed">Pega tu API Key de Google AI Studio para activar respuestas avanzadas ilimitadas. Si el campo está vacío, la app usará el motor interno.</p>
                                        <input 
                                            type="password" 
                                            value={userApiKey} 
                                            onChange={e => setUserApiKey(e.target.value)} 
                                            placeholder="Tu API Key de Gemini..." 
                                            className="w-full p-4 rounded-2xl border-2 dark:bg-slate-900 outline-none text-[14px] font-mono focus:border-emerald-500 transition-all mb-4" 
                                        />
                                        <div className="flex justify-between items-center bg-white/50 dark:bg-black/20 p-3 rounded-xl">
                                            <span className="text-[10px] font-bold uppercase opacity-40">Estado:</span>
                                            <span className={`text-[10px] font-black uppercase ${userApiKey ? 'text-emerald-600' : 'text-amber-600'}`}>
                                                {userApiKey ? 'Gemini Activado' : 'Motor Local (Offline)'}
                                            </span>
                                        </div>
                                    </div>

                                    <button onClick={downloadFullBible} className="w-full p-7 bg-slate-100 dark:bg-slate-800 rounded-[2rem] font-black uppercase flex justify-between items-center shadow-sm">Actualizar Base Local <i className="fa-solid fa-cloud-arrow-down opacity-30"></i></button>
                                </div>
                            </div>
                        )}

                        {view === 'nav' && (
                            <div className="animate-fade-in w-full px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Biblioteca</h2>
                                <div className="grid grid-cols-2 gap-3">
                                    {bible.books.map(b => (
                                        <button key={b} onClick={() => { setCurrentChapter({book:b, chapter:1}); setView('reading'); }} className={`p-5 rounded-[1.5rem] border-2 font-black text-[14px] text-left active:scale-[0.96] transition-all overflow-hidden text-ellipsis ${currentChapter.book === b ? 'border-emerald-500 bg-emerald-50 text-emerald-700 dark:bg-emerald-950' : 'border-slate-50 dark:border-slate-800 dark:bg-slate-800 shadow-sm'}`}>{b}</button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'search' && (
                            <div className="animate-fade-in px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Buscador</h2>
                                <div className="flex gap-2 mb-6">
                                    <input value={searchQ} onChange={e => setSearchQ(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} placeholder="Buscar..." className="flex-grow p-4 text-[17px] rounded-2xl border-2 dark:bg-slate-800 outline-none" />
                                    <button onClick={handleSearch} className="bg-emerald-600 text-white px-5 rounded-2xl shadow-xl shrink-0"><i className="fa-solid fa-magnifying-glass text-xl"></i></button>
                                </div>
                                <div className="space-y-3">
                                    {searchRes.map((r, i) => (
                                        <div key={i} onClick={() => { setCurrentChapter({book:r.b, chapter:r.c}); setView('reading'); }} className="p-5 rounded-[1.5rem] border dark:border-slate-700 bg-white dark:bg-slate-800 cursor-pointer shadow-sm active:scale-[0.98]">
                                            <span className="text-[11px] font-black text-emerald-600 italic">{r.b} {r.c}:{r.v}</span>
                                            <p className="text-[17px] opacity-80 line-clamp-3 mt-1">"{r.t}"</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'plans' && (
                            <div className="animate-fade-in px-4 pt-6 pb-32">
                                <h2 className="text-base font-black text-emerald-600 uppercase tracking-widest mb-6">Planes</h2>
                                <div className="grid gap-6">
                                    {INITIAL_PLANS.map(plan => {
                                        const completed = planProgress[plan.id] || [];
                                        const progress = Math.round((completed.length / plan.days.length) * 100);
                                        return (
                                            <div key={plan.id} className="p-6 rounded-[2rem] bg-emerald-50 dark:bg-emerald-950/20 border-2 border-emerald-100 dark:border-emerald-900 shadow-sm relative transition-all active:scale-[0.99] w-full">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div><h3 className="font-black text-lg text-emerald-800 dark:text-emerald-400">{plan.title}</h3><p className="text-[10px] font-black uppercase opacity-40 mt-1 tracking-widest">{progress}%</p></div>
                                                    {progress === 100 && <i className="fa-solid fa-circle-check text-emerald-500 text-2xl"></i>}
                                                </div>
                                                <div className="w-full h-2.5 bg-white dark:bg-slate-800 rounded-full mb-6 overflow-hidden border dark:border-slate-700 shadow-inner">
                                                    <div className="h-full bg-emerald-500 transition-all duration-700 ease-out" style={{ width: `${progress}%` }}></div>
                                                </div>
                                                <div className="space-y-3">
                                                    {plan.days.map((d, idx) => {
                                                        const isDone = completed.includes(idx);
                                                        return (
                                                            <div key={idx} className="flex gap-3 items-center group w-full overflow-hidden">
                                                                <button onClick={() => togglePlanDay(plan.id, idx)} className={`w-10 h-10 shrink-0 rounded-xl flex items-center justify-center transition-all border-2 ${isDone ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 text-slate-300'}`}><i className={`fa-solid ${isDone ? 'fa-check' : 'fa-circle-dot text-[10px]'}`}></i></button>
                                                                <button onClick={() => { setCurrentChapter({book: d.b, chapter: d.c}); setView('reading'); }} className="flex-grow min-w-0 text-left p-3.5 rounded-xl bg-white/50 dark:bg-slate-800/40 border dark:border-slate-700 text-[14px] font-bold flex justify-between items-center group-active:translate-x-1 transition-transform overflow-hidden"><span className={`truncate ${isDone ? 'opacity-40 line-through' : ''}`}>Día {idx + 1}: {d.b} {d.c}</span><i className="fa-solid fa-book-open opacity-30 text-xs shrink-0 ml-2"></i></button>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

